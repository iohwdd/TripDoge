# P0修复真实测试计划

**制定日期**: 2025-11-21  
**目标**: 为每个P0修复点编写真实的测试，验证修复是否真正生效

---

## 测试策略

### 1. 单元测试（已部分完成）
- ✅ FileValidationUtilsTest - 文件验证逻辑测试
- ⚠️ 其他测试需要补充实际功能验证

### 2. 集成测试（需要补充）
- Spring Boot集成测试
- 使用Testcontainers进行数据库/Redis测试
- 实际HTTP请求测试

### 3. 端到端测试（需要补充）
- 完整业务流程测试
- 异常场景测试

---

## 测试用例设计

### P0-1: 注册流程事务保护

#### 测试用例1: 事务回滚测试
**目标**: 验证注册流程在异常情况下是否回滚

**步骤**:
1. 准备测试数据：有效的验证码、邮箱
2. 模拟用户创建失败（例如数据库约束冲突）
3. 验证：验证码未被消费，邮箱检查状态回滚

**预期结果**: 
- 事务回滚
- 验证码仍然有效
- 数据库中没有部分数据

**测试方法**: Spring Boot集成测试 + Testcontainers

---

### P0-2: 验证码存储迁移到Redis

#### 测试用例1: Redis存储测试
**目标**: 验证验证码正确存储到Redis

**步骤**:
1. 调用 `generateAndSendCode(email)`
2. 检查Redis中是否存在 `email:code:{code}` key
3. 验证value是否为邮箱地址
4. 验证TTL是否为5分钟

**预期结果**:
- Redis中存在验证码key
- Value正确
- TTL正确

**测试方法**: Spring Boot集成测试 + Testcontainers Redis

#### 测试用例2: 验证码过期测试
**目标**: 验证验证码过期机制

**步骤**:
1. 生成验证码
2. 等待6分钟（超过5分钟过期时间）
3. 尝试验证验证码

**预期结果**:
- 验证失败
- Redis中key已过期

**测试方法**: Spring Boot集成测试 + 时间模拟

#### 测试用例3: 原子删除测试
**目标**: 验证验证码只能使用一次

**步骤**:
1. 生成验证码
2. 并发调用 `verifyCode()` 两次
3. 检查只有一次验证成功

**预期结果**:
- 只有一次验证成功
- 第二次验证失败（验证码已删除）

**测试方法**: 并发测试 + Spring Boot集成测试

#### 测试用例4: Redis不可用降级测试
**目标**: 验证Redis不可用时的降级处理

**步骤**:
1. 停止Redis服务
2. 调用 `generateAndSendCode(email)`
3. 检查日志中是否有降级警告

**预期结果**:
- 方法不抛出异常
- 日志中有降级警告
- 验证码仍然返回（但可能无法验证）

**测试方法**: Spring Boot集成测试 + Redis模拟故障

---

### P0-3: 文件大小和类型限制

#### 测试用例1: 文件大小限制测试（已通过单元测试）
**目标**: 验证文件大小限制

**步骤**:
1. 上传101MB的文件
2. 检查是否被拒绝

**预期结果**:
- 上传被拒绝
- 返回错误信息

**测试方法**: ✅ 单元测试已覆盖

#### 测试用例2: 文件类型限制测试（已通过单元测试）
**目标**: 验证文件类型限制

**步骤**:
1. 上传不支持的文件类型（如.exe）
2. 检查是否被拒绝

**预期结果**:
- 上传被拒绝
- 返回错误信息

**测试方法**: ✅ 单元测试已覆盖

#### 测试用例3: 实际HTTP上传测试
**目标**: 验证实际HTTP请求中的文件验证

**步骤**:
1. 使用MockMvc发送POST请求上传文件
2. 检查响应状态码和错误信息

**预期结果**:
- 大文件返回400错误
- 不支持类型返回400错误

**测试方法**: Spring Boot集成测试 + MockMvc

---

### P0-4: SSE连接异常处理

#### 测试用例1: SSE超时测试
**目标**: 验证SSE连接超时处理

**步骤**:
1. 建立SSE连接
2. 模拟超时（等待31分钟或使用时间模拟）
3. 检查 `onTimeout()` 回调是否被调用
4. 检查连接是否正确关闭

**预期结果**:
- `onTimeout()` 回调被调用
- 连接正确关闭
- 资源正确释放

**测试方法**: Spring Boot集成测试 + MockMvc + 时间模拟

#### 测试用例2: 客户端断开连接测试
**目标**: 验证客户端断开连接时的处理

**步骤**:
1. 建立SSE连接
2. 模拟客户端断开连接
3. 检查 `onError()` 或 `onCompletion()` 回调是否被调用
4. 检查资源是否正确释放

**预期结果**:
- 回调被调用
- 资源正确释放
- 无资源泄漏

**测试方法**: Spring Boot集成测试 + HTTP客户端模拟

---

### P0-5: 临时文件清理机制

#### 测试用例1: 临时文件清理测试
**目标**: 验证临时文件清理功能

**步骤**:
1. 创建临时文件（带 `tripdog_` 前缀）
2. 设置文件修改时间为25小时前
3. 调用 `cleanupTempFiles()`
4. 检查文件是否被删除

**预期结果**:
- 文件被删除
- 日志中有清理记录

**测试方法**: 单元测试 + 文件系统操作

#### 测试用例2: 定时任务执行测试
**目标**: 验证定时任务正确执行

**步骤**:
1. 创建多个过期临时文件
2. 等待定时任务执行（或手动触发）
3. 检查文件是否被清理

**预期结果**:
- 定时任务执行
- 过期文件被清理

**测试方法**: Spring Boot集成测试 + 时间模拟

#### 测试用例3: 清理失败不影响主流程测试
**目标**: 验证清理失败时不影响上传流程

**步骤**:
1. 模拟文件删除失败（权限问题）
2. 执行文档上传流程
3. 检查上传是否成功
4. 检查日志中是否有警告

**预期结果**:
- 上传成功
- 日志中有清理失败警告
- 不抛出异常

**测试方法**: Spring Boot集成测试 + 文件权限模拟

---

## 测试执行计划

### 阶段1: 补充单元测试（当前）
- [x] FileValidationUtilsTest（已完成）
- [ ] TempFileCleanupServiceTest（补充实际文件操作测试）
- [ ] EmailServiceImplTest（补充Redis操作测试）

### 阶段2: 编写集成测试（下一步）
- [ ] 注册流程事务测试
- [ ] Redis验证码存储测试
- [ ] SSE连接测试
- [ ] 文件上传HTTP测试

### 阶段3: 执行测试并记录结果
- [ ] 运行所有测试
- [ ] 记录测试结果
- [ ] 生成测试报告

---

## 测试环境要求

### 依赖
- Spring Boot Test
- Testcontainers（MySQL, Redis）
- MockMvc
- JUnit 5

### 配置
- 测试配置文件
- 测试数据库
- 测试Redis实例

---

**计划制定时间**: 2025-11-21  
**计划制定人**: AI Assistant

