# TripDoge åç«¯é—®é¢˜æ’æŸ¥æŠ¥å‘Š

**æ’æŸ¥æ—¶é—´**: 2025-11-21  
**æ’æŸ¥èŒƒå›´**: åç«¯ä»£ç å®Œæ•´æ’æŸ¥  
**å¯¹æ¯”åŸºå‡†**: ç”¨æˆ·æä¾›çš„æ’æŸ¥æ€»ç»“

---

## ğŸ“‹ é—®é¢˜åˆ†ç±»æ±‡æ€»

### ğŸ”´ ä¸¥é‡é—®é¢˜ï¼ˆå¿…é¡»ä¿®å¤ï¼‰

### ğŸŸ¡ ä¸­ç­‰é—®é¢˜ï¼ˆå»ºè®®ä¿®å¤ï¼‰

### ğŸŸ¢ è½»å¾®é—®é¢˜ï¼ˆå¯é€‰ä¼˜åŒ–ï¼‰

---

## 1. MinIO ä¾èµ–é—®é¢˜

### âœ… å·²ä¿®å¤çš„éƒ¨åˆ†
- **UserServiceImpl**: å·²æ·»åŠ  try-catchï¼ŒMinIO å¤±è´¥æ—¶å›é€€åˆ°é»˜è®¤å¤´åƒ
- **RoleController**: å·²æ·»åŠ  try-catchï¼ŒMinIO å¤±è´¥æ—¶å¿½ç•¥å¼‚å¸¸ç»§ç»­è¿”å›

### âŒ æœªä¿®å¤çš„é—®é¢˜

#### 1.1 DocController - ä¸‹è½½æ¥å£ï¼ˆä¸¥é‡ï¼‰
**ä½ç½®**: `DocController.download()` (è¡Œ207-230)

**é—®é¢˜**:
```java
// ä»MinIOä¸‹è½½æ–‡ä»¶
InputStream inputStream = minioClient.getObject(...);
byte[] bytes = inputStream.readAllBytes();
```
- **æ— å®¹é”™å¤„ç†**: MinIO è¿æ¥å¤±è´¥æˆ–æ–‡ä»¶ä¸å­˜åœ¨æ—¶ç›´æ¥æŠ›å‡ºå¼‚å¸¸
- **è¿”å›500é”™è¯¯**: catch å—åªè¿”å› `ResponseEntity.internalServerError()`ï¼Œæ²¡æœ‰æ˜ç¡®çš„é”™è¯¯ç 
- **èµ„æºæ³„æ¼é£é™©**: å¦‚æœ `readAllBytes()` å¤±è´¥ï¼Œ`inputStream` å¯èƒ½æœªå…³é—­

**å½±å“**: ç”¨æˆ·æ— æ³•ä¸‹è½½æ–‡æ¡£ï¼Œè¿”å›500é”™è¯¯ï¼Œä½“éªŒå·®

**å»ºè®®ä¿®å¤**:
```java
try {
    InputStream inputStream = minioClient.getObject(...);
    try {
        byte[] bytes = inputStream.readAllBytes();
        // ... è¿”å›æ–‡ä»¶
    } finally {
        inputStream.close();
    }
} catch (MinioException e) {
    log.error("MinIOä¸‹è½½å¤±è´¥: fileId={}, error={}", fileId, e.getMessage());
    return ResponseEntity.status(404).body("æ–‡ä»¶ä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—®".getBytes());
} catch (Exception e) {
    log.error("æ–‡æ¡£ä¸‹è½½å¼‚å¸¸", e);
    return ResponseEntity.status(500).body("æ–‡ä»¶ä¸‹è½½å¤±è´¥".getBytes());
}
```

#### 1.2 DocController - åˆ é™¤æ¥å£ï¼ˆä¸¥é‡ï¼‰
**ä½ç½®**: `DocController.delete()` (è¡Œ262-267)

**é—®é¢˜**:
```java
// ä»MinIOåˆ é™¤æ–‡ä»¶
minioClient.removeObject(...);
// åˆ é™¤å¯¹åº”çš„å‘é‡æ•°æ®
vectorDataService.deleteByDocumentId(fileId);
```
- **æ— å®¹é”™å¤„ç†**: MinIO åˆ é™¤å¤±è´¥ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå¯¼è‡´åç»­å‘é‡åˆ é™¤å’Œæ•°æ®åº“åˆ é™¤æ— æ³•æ‰§è¡Œ
- **æ•°æ®ä¸ä¸€è‡´**: å¦‚æœ MinIO åˆ é™¤å¤±è´¥ä½†å‘é‡åˆ é™¤æˆåŠŸï¼Œä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´
- **é”™è¯¯ä¿¡æ¯ä¸æ˜ç¡®**: ç»Ÿä¸€è¿”å› `SYSTEM_ERROR`ï¼Œæ— æ³•åŒºåˆ†æ˜¯ MinIOã€å‘é‡åº“è¿˜æ˜¯æ•°æ®åº“çš„é—®é¢˜

**å½±å“**: åˆ é™¤æ“ä½œå¯èƒ½éƒ¨åˆ†æˆåŠŸï¼Œæ•°æ®ä¸ä¸€è‡´

**å»ºè®®ä¿®å¤**:
```java
boolean minioDeleted = false;
try {
    minioClient.removeObject(...);
    minioDeleted = true;
    log.info("MinIOæ–‡ä»¶åˆ é™¤æˆåŠŸ: {}", fileUrl);
} catch (Exception e) {
    log.warn("MinIOæ–‡ä»¶åˆ é™¤å¤±è´¥ï¼ˆç»§ç»­æ‰§è¡Œå…¶ä»–åˆ é™¤æ“ä½œï¼‰: fileUrl={}, error={}", fileUrl, e.getMessage());
    // ç»§ç»­æ‰§è¡Œå‘é‡å’Œæ•°æ®åº“åˆ é™¤ï¼Œé¿å…æ•°æ®ä¸ä¸€è‡´
}

// åˆ é™¤å‘é‡æ•°æ®ï¼ˆå…è®¸å¤±è´¥ï¼‰
try {
    vectorDataService.deleteByDocumentId(fileId);
} catch (Exception e) {
    log.warn("å‘é‡æ•°æ®åˆ é™¤å¤±è´¥ï¼ˆç»§ç»­æ‰§è¡Œæ•°æ®åº“åˆ é™¤ï¼‰: fileId={}, error={}", fileId, e.getMessage());
}

// åˆ é™¤æ•°æ®åº“è®°å½•
if (!docService.deleteDoc(fileId)) {
    return Result.error(ErrorCode.SYSTEM_ERROR);
}

if (!minioDeleted) {
    return Result.success("æ–‡æ¡£å·²åˆ é™¤ï¼Œä½†MinIOæ–‡ä»¶åˆ é™¤å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ¸…ç†");
}
return Result.success("æ–‡æ¡£åˆ é™¤æˆåŠŸ");
```

#### 1.3 FileUploadUtils - åˆ é™¤æ–¹æ³•ï¼ˆä¸­ç­‰ï¼‰
**ä½ç½®**: `FileUploadUtils.deleteFromMinio()` (è¡Œ149-162)

**é—®é¢˜**:
```java
public static void deleteFromMinio(...) {
    try {
        minioClient.removeObject(...);
    } catch (Exception e) {
        log.error("MinIOæ–‡ä»¶åˆ é™¤å¤±è´¥", e);
        throw new RuntimeException("æ–‡ä»¶åˆ é™¤å¤±è´¥: " + e.getMessage());
    }
}
```
- **ç›´æ¥æŠ›å‡ºå¼‚å¸¸**: è°ƒç”¨æ–¹æ— æ³•åŒºåˆ†æ˜¯æ–‡ä»¶ä¸å­˜åœ¨è¿˜æ˜¯è¿æ¥å¤±è´¥
- **æ— è¿”å›å€¼**: æ— æ³•çŸ¥é“åˆ é™¤æ˜¯å¦æˆåŠŸ

**å»ºè®®ä¿®å¤**:
```java
public static boolean deleteFromMinio(String objectKey, MinioClient minioClient, String bucketName) {
    try {
        minioClient.removeObject(...);
        log.info("æ–‡ä»¶åˆ é™¤æˆåŠŸ: å¯¹è±¡è·¯å¾„={}", objectKey);
        return true;
    } catch (MinioException e) {
        if (e.getMessage().contains("NoSuchKey") || e.getMessage().contains("does not exist")) {
            log.warn("æ–‡ä»¶ä¸å­˜åœ¨ï¼ˆå¯èƒ½å·²åˆ é™¤ï¼‰: å¯¹è±¡è·¯å¾„={}", objectKey);
            return true; // æ–‡ä»¶ä¸å­˜åœ¨è§†ä¸ºåˆ é™¤æˆåŠŸ
        }
        log.error("MinIOæ–‡ä»¶åˆ é™¤å¤±è´¥: å¯¹è±¡è·¯å¾„={}, error={}", objectKey, e.getMessage(), e);
        return false;
    } catch (Exception e) {
        log.error("MinIOæ–‡ä»¶åˆ é™¤å¼‚å¸¸: å¯¹è±¡è·¯å¾„={}, error={}", objectKey, e.getMessage(), e);
        return false;
    }
}
```

#### 1.4 FileUploadUtils - è·å–URLæ–¹æ³•ï¼ˆä¸­ç­‰ï¼‰
**ä½ç½®**: `FileUploadUtils.getUrlFromMinio()` (è¡Œ127-140)

**é—®é¢˜**:
```java
public String getUrlFromMinio(String minioUrl) {
    try {
        return minioClient.getPresignedObjectUrl(...);
    } catch (Exception e) {
        throw new RuntimeException(e);
    }
}
```
- **ç›´æ¥æŠ›å‡ºå¼‚å¸¸**: è°ƒç”¨æ–¹æ— æ³•å¤„ç†ï¼Œå¯èƒ½å¯¼è‡´æ•´ä¸ªè¯·æ±‚å¤±è´¥
- **æ— é™çº§æ–¹æ¡ˆ**: æ— æ³•è¿”å›é»˜è®¤URLæˆ–å ä½ç¬¦

**å»ºè®®ä¿®å¤**:
```java
public String getUrlFromMinio(String minioUrl) {
    try {
        return minioClient.getPresignedObjectUrl(...);
    } catch (Exception e) {
        log.error("è·å–MinIOé¢„ç­¾åURLå¤±è´¥: minioUrl={}, error={}", minioUrl, e.getMessage(), e);
        // è¿”å›åŸå§‹URLæˆ–é»˜è®¤å ä½ç¬¦
        return minioUrl != null ? minioUrl : Constants.DEFAULT_AVATAR;
    }
}
```

---

## 2. PgVector ä¾èµ–é—®é¢˜

### âŒ ä¸¥é‡é—®é¢˜

#### 2.1 VectorDataService - æ‰€æœ‰æ–¹æ³•ç›´æ¥æŠ›å‡º RuntimeExceptionï¼ˆä¸¥é‡ï¼‰
**ä½ç½®**: `VectorDataService` æ‰€æœ‰æ–¹æ³• (è¡Œ31-149)

**é—®é¢˜**:
```java
public void deleteByDocumentId(String fileId) {
    try {
        embeddingStore.removeAll(docFilter);
    } catch (Exception e) {
        log.error("åˆ é™¤æ–‡æ¡£å‘é‡æ•°æ®å¤±è´¥", fileId, e);
        throw new RuntimeException("åˆ é™¤æ–‡æ¡£å‘é‡æ•°æ®å¤±è´¥", e);
    }
}
```
- **æ‰€æœ‰å¼‚å¸¸éƒ½æŠ›å‡º**: å¦‚æœ pgvector æœªé…ç½®æˆ–è¿æ¥å¤±è´¥ï¼Œæ‰€æœ‰å‘é‡æ“ä½œéƒ½ä¼šå¤±è´¥
- **æ— é™çº§æ–¹æ¡ˆ**: æ— æ³•è·³è¿‡å‘é‡åŒ–æ­¥éª¤ï¼Œå¯¼è‡´æ–‡æ¡£ä¸Šä¼ /åˆ é™¤åŠŸèƒ½å®Œå…¨ä¸å¯ç”¨
- **å½±å“èŒƒå›´å¹¿**: DocController çš„ä¸Šä¼ å’Œåˆ é™¤éƒ½ä¾èµ–æ­¤æœåŠ¡

**å½±å“**: 
- æ–‡æ¡£ä¸Šä¼ å¤±è´¥ï¼ˆå¦‚æœå‘é‡åŒ–å¤±è´¥ï¼‰
- æ–‡æ¡£åˆ é™¤å¤±è´¥ï¼ˆå¦‚æœå‘é‡åˆ é™¤å¤±è´¥ï¼‰
- æ•´ä¸ªæ–‡æ¡£åŠŸèƒ½ä¸å¯ç”¨ï¼ˆå¦‚æœ pgvector æœªé…ç½®ï¼‰

**å»ºè®®ä¿®å¤**:
```java
@Service
@RequiredArgsConstructor
@Slf4j
public class VectorDataService {
    
    private final EmbeddingStore<TextSegment> embeddingStore;
    private volatile boolean vectorStoreAvailable = true; // å‘é‡å­˜å‚¨å¯ç”¨æ€§æ ‡å¿—
    
    @PostConstruct
    public void checkVectorStoreAvailability() {
        try {
            // å°è¯•ä¸€ä¸ªç®€å•çš„æŸ¥è¯¢æ“ä½œæ¥æ£€æŸ¥è¿æ¥
            embeddingStore.findAll();
            vectorStoreAvailable = true;
            log.info("å‘é‡å­˜å‚¨è¿æ¥æ£€æŸ¥æˆåŠŸ");
        } catch (Exception e) {
            vectorStoreAvailable = false;
            log.warn("å‘é‡å­˜å‚¨ä¸å¯ç”¨ï¼Œå°†è·³è¿‡å‘é‡åŒ–æ“ä½œ: {}", e.getMessage());
        }
    }
    
    public void deleteByDocumentId(String fileId) {
        if (!vectorStoreAvailable) {
            log.warn("å‘é‡å­˜å‚¨ä¸å¯ç”¨ï¼Œè·³è¿‡åˆ é™¤æ“ä½œ: fileId={}", fileId);
            return; // é™é»˜å¤±è´¥ï¼Œä¸å½±å“ä¸»æµç¨‹
        }
        
        try {
            Filter docFilter = new IsEqualTo("fileId", fileId);
            embeddingStore.removeAll(docFilter);
            log.info("åˆ é™¤æ–‡æ¡£ {} çš„å‘é‡æ•°æ®æˆåŠŸ", fileId);
        } catch (Exception e) {
            log.error("åˆ é™¤æ–‡æ¡£ {} çš„å‘é‡æ•°æ®å¤±è´¥ï¼Œä½†ä¸å½±å“ä¸»æµç¨‹: {}", fileId, e.getMessage(), e);
            // ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œå…è®¸ä¸»æµç¨‹ç»§ç»­
            vectorStoreAvailable = false; // æ ‡è®°ä¸ºä¸å¯ç”¨
        }
    }
    
    // å…¶ä»–æ–¹æ³•ç±»ä¼¼å¤„ç†...
}
```

#### 2.2 DocController - ä¸Šä¼ æ¥å£å¼ºä¾èµ–å‘é‡åŒ–ï¼ˆä¸¥é‡ï¼‰
**ä½ç½®**: `DocController.upload()` (è¡Œ128-140)

**é—®é¢˜**:
```java
try {
    DocumentParser parser = new ApacheTikaDocumentParser();
    Document doc = loadDocument(localFile.getAbsolutePath(), parser);
    ingestor.ingest(doc); // å¦‚æœå¤±è´¥ï¼Œæ•´ä¸ªä¸Šä¼ å¤±è´¥
    // ...
} finally {
    FileUploadUtils.deleteLocalFile(localFile);
}
```
- **å‘é‡åŒ–å¤±è´¥å¯¼è‡´ä¸Šä¼ å¤±è´¥**: å³ä½¿æ–‡ä»¶å·²ä¸Šä¼ åˆ° MinIO å’Œæ•°æ®åº“ï¼Œå¦‚æœå‘é‡åŒ–å¤±è´¥ï¼Œæ•´ä¸ªæ“ä½œå¤±è´¥
- **æ•°æ®ä¸ä¸€è‡´**: MinIO å’Œæ•°æ®åº“å·²æœ‰æ•°æ®ï¼Œä½†å‘é‡åº“æ²¡æœ‰ï¼Œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´

**å»ºè®®ä¿®å¤**:
```java
try {
    // è§£ææ–‡æ¡£å¹¶åˆ›å»ºå‘é‡åµŒå…¥
    DocumentParser parser = new ApacheTikaDocumentParser();
    Document doc = loadDocument(localFile.getAbsolutePath(), parser);
    
    try {
        ingestor.ingest(doc);
        log.info("æ–‡æ¡£å‘é‡åŒ–æˆåŠŸ: fileId={}", fileId);
    } catch (Exception e) {
        log.warn("æ–‡æ¡£å‘é‡åŒ–å¤±è´¥ï¼ˆæ–‡ä»¶å·²ä¸Šä¼ ï¼Œä½†æ— æ³•è¿›è¡ŒAIæ£€ç´¢ï¼‰: fileId={}, error={}", fileId, e.getMessage(), e);
        // ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œå…è®¸ä¸Šä¼ æˆåŠŸï¼Œä½†è®°å½•è­¦å‘Š
    }
    
    // è¿”å›æ–‡æ¡£ä¿¡æ¯
    DocVO docVO = docService.getDocByFileId(fileId);
    return Result.success(docVO);
} finally {
    FileUploadUtils.deleteLocalFile(localFile);
}
```

#### 2.3 PgVectorEmbeddingStoreInit - Bean åˆå§‹åŒ–æ— å®¹é”™ï¼ˆä¸¥é‡ï¼‰
**ä½ç½®**: `PgVectorEmbeddingStoreInit.textEmbeddingStore()` (è¡Œ34-46)

**é—®é¢˜**:
```java
@Bean
EmbeddingStore<TextSegment> textEmbeddingStore() {
    return PgVectorEmbeddingStore.builder()
        .host(pgVectorProperties.getHost())
        .port(pgVectorProperties.getPort())
        // ...
        .build();
}
```
- **å¯åŠ¨æ—¶å³å¤±è´¥**: å¦‚æœ pgvector æœªé…ç½®æˆ–è¿æ¥å¤±è´¥ï¼Œåº”ç”¨å¯åŠ¨å¤±è´¥
- **æ— æ¡ä»¶æ³¨è§£**: æ²¡æœ‰ `@ConditionalOnProperty` ç­‰æ¡ä»¶æ³¨è§£ï¼Œæ— æ³•å¯é€‰å¯ç”¨

**å»ºè®®ä¿®å¤**:
```java
@Bean
@ConditionalOnProperty(name = "pgvector.enabled", havingValue = "true", matchIfMissing = false)
EmbeddingStore<TextSegment> textEmbeddingStore() {
    try {
        EmbeddingStore<TextSegment> store = PgVectorEmbeddingStore.builder()
            .host(pgVectorProperties.getHost())
            .port(pgVectorProperties.getPort())
            // ...
            .build();
        log.info("PgVectoråµŒå…¥å­˜å‚¨åˆå§‹åŒ–æˆåŠŸ");
        return store;
    } catch (Exception e) {
        log.error("PgVectoråµŒå…¥å­˜å‚¨åˆå§‹åŒ–å¤±è´¥ï¼Œæ–‡æ¡£å‘é‡åŒ–åŠŸèƒ½å°†ä¸å¯ç”¨: {}", e.getMessage(), e);
        throw new BeanCreationException("PgVectoråˆå§‹åŒ–å¤±è´¥", e);
    }
}

// æä¾›ä¸€ä¸ªç©ºçš„EmbeddingStoreä½œä¸ºfallback
@Bean
@ConditionalOnMissingBean(EmbeddingStore.class)
EmbeddingStore<TextSegment> fallbackEmbeddingStore() {
    log.warn("ä½¿ç”¨ç©ºçš„EmbeddingStoreä½œä¸ºfallbackï¼Œå‘é‡åŒ–åŠŸèƒ½ä¸å¯ç”¨");
    return new InMemoryEmbeddingStore<>(); // æˆ–è¿”å›nullï¼Œåœ¨VectorDataServiceä¸­æ£€æŸ¥
}
```

---

## 3. Redis/ä¼šè¯é—®é¢˜

### âŒ ä¸¥é‡é—®é¢˜

#### 3.1 RedisService - å¼‚å¸¸è¢«åæ‰ï¼ˆä¸¥é‡ï¼‰
**ä½ç½®**: `RedisService` æ‰€æœ‰æ–¹æ³• (è¡Œ30-239)

**é—®é¢˜**:
```java
public void set(String key, Object value) {
    try {
        redisTemplate.opsForValue().set(key, value);
    } catch (Exception e) {
        log.error("Redis setæ“ä½œå¤±è´¥, key: {}", key, e);
        // ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œé™é»˜å¤±è´¥
    }
}
```
- **æ‰€æœ‰å¼‚å¸¸éƒ½è¢«æ•è·**: Redis è¿æ¥å¤±è´¥æ—¶ï¼Œæ“ä½œé™é»˜å¤±è´¥ï¼Œè°ƒç”¨æ–¹æ— æ³•æ„ŸçŸ¥
- **æ— è¿”å›å€¼**: æ— æ³•çŸ¥é“æ“ä½œæ˜¯å¦æˆåŠŸ
- **å½±å“**: UserSessionService æ— æ³•çŸ¥é“ Redis æ˜¯å¦å¯ç”¨

**å½±å“**: 
- ç”¨æˆ·ç™»å½•åï¼ŒSession å¯èƒ½æœªä¿å­˜åˆ° Redisï¼Œä½†åº”ç”¨è®¤ä¸ºå·²ä¿å­˜
- åç»­è¯·æ±‚æ— æ³•è·å– Sessionï¼Œå¯¼è‡´"ç”¨æˆ·æœªç™»å½•"é”™è¯¯
- ç”¨æˆ·ä½“éªŒå·®ï¼Œæ— æ³•ç†è§£ä¸ºä»€ä¹ˆåˆšç™»å½•å°±æç¤ºæœªç™»å½•

**å»ºè®®ä¿®å¤**:
```java
@Service
@RequiredArgsConstructor
@Slf4j
public class RedisService {
    
    private final RedisTemplate<String, Object> redisTemplate;
    private final StringRedisTemplate stringRedisTemplate;
    private volatile boolean redisAvailable = true; // Rediså¯ç”¨æ€§æ ‡å¿—
    
    @PostConstruct
    public void checkRedisAvailability() {
        try {
            redisTemplate.opsForValue().set("health_check", "ok", 1, TimeUnit.SECONDS);
            redisAvailable = true;
            log.info("Redisè¿æ¥æ£€æŸ¥æˆåŠŸ");
        } catch (Exception e) {
            redisAvailable = false;
            log.error("Redisè¿æ¥ä¸å¯ç”¨ï¼Œå°†ä½¿ç”¨å†…å­˜Session: {}", e.getMessage());
        }
    }
    
    public boolean set(String key, Object value) {
        if (!redisAvailable) {
            log.debug("Redisä¸å¯ç”¨ï¼Œè·³è¿‡setæ“ä½œ: key={}", key);
            return false;
        }
        
        try {
            redisTemplate.opsForValue().set(key, value);
            return true;
        } catch (Exception e) {
            log.error("Redis setæ“ä½œå¤±è´¥, key: {}", key, e);
            redisAvailable = false; // æ ‡è®°ä¸ºä¸å¯ç”¨
            return false;
        }
    }
    
    // å…¶ä»–æ–¹æ³•ç±»ä¼¼ï¼Œè¿”å›booleanè¡¨ç¤ºæ˜¯å¦æˆåŠŸ
}
```

#### 3.2 UserSessionService - æ— æœ¬åœ° Fallbackï¼ˆä¸¥é‡ï¼‰
**ä½ç½®**: `UserSessionService` æ‰€æœ‰æ–¹æ³•

**é—®é¢˜**:
- **å®Œå…¨ä¾èµ– Redis**: å¦‚æœ Redis ä¸å¯ç”¨ï¼Œæ‰€æœ‰ Session æ“ä½œéƒ½å¤±è´¥
- **æ— å†…å­˜ Session æ–¹æ¡ˆ**: æ²¡æœ‰æœ¬åœ°å†…å­˜ä½œä¸º fallback
- **ç™»å½•çŠ¶æ€ä¸å¯ç”¨**: Redis æ•…éšœæ—¶ï¼Œç”¨æˆ·æ— æ³•ç™»å½•æˆ–ç™»å½•åç«‹å³å¤±æ•ˆ

**å»ºè®®ä¿®å¤**:
```java
@Service
@RequiredArgsConstructor
@Slf4j
public class UserSessionService {
    
    private final RedisService redisService;
    private final ConcurrentHashMap<String, UserInfoVO> localSessionStore = new ConcurrentHashMap<>();
    private final ConcurrentHashMap<Long, String> localUserTokenMap = new ConcurrentHashMap<>();
    
    public String createSession(UserInfoVO userInfo) {
        String token = TokenUtils.generateToken();
        String sessionKey = SESSION_KEY_PREFIX + token;
        
        // ä¼˜å…ˆä½¿ç”¨Redis
        boolean redisSuccess = redisService.setObject(sessionKey, userInfo, SESSION_TIMEOUT, TimeUnit.MINUTES);
        
        if (!redisSuccess) {
            // Rediså¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°å†…å­˜
            log.warn("Redisä¸å¯ç”¨ï¼Œä½¿ç”¨æœ¬åœ°å†…å­˜Session: userId={}", userInfo.getId());
            localSessionStore.put(sessionKey, userInfo);
            localUserTokenMap.put(userInfo.getId(), token);
        }
        
        return token;
    }
    
    public UserInfoVO getSession(String token) {
        if (token == null || token.trim().isEmpty()) {
            return null;
        }
        
        String sessionKey = SESSION_KEY_PREFIX + token;
        
        // ä¼˜å…ˆä»Redisè·å–
        UserInfoVO userInfo = redisService.getObject(sessionKey, UserInfoVO.class);
        
        if (userInfo == null) {
            // Redisä¸­æ²¡æœ‰ï¼Œå°è¯•ä»æœ¬åœ°å†…å­˜è·å–
            userInfo = localSessionStore.get(sessionKey);
            if (userInfo != null) {
                log.debug("ä»æœ¬åœ°å†…å­˜è·å–Session: userId={}", userInfo.getId());
            }
        }
        
        return userInfo;
    }
    
    // å…¶ä»–æ–¹æ³•ç±»ä¼¼å¤„ç†...
}
```

---

## 4. é‚®ä»¶æœåŠ¡é—®é¢˜

### âŒ ä¸¥é‡é—®é¢˜

#### 4.1 EmailServiceImpl - å‘é€å¤±è´¥ä»è¿”å›æˆåŠŸï¼ˆä¸¥é‡ï¼‰
**ä½ç½®**: `EmailServiceImpl.sendVerificationCode()` (è¡Œ57-69)

**é—®é¢˜**:
```java
} catch (Exception e) {
    log.error("éªŒè¯ç é‚®ä»¶å‘é€å¤±è´¥", e);
    // å¼€å‘é˜¶æ®µï¼Œå³ä½¿é‚®ä»¶å‘é€å¤±è´¥ä¹Ÿè¿”å›trueï¼Œæ–¹ä¾¿æµ‹è¯•
    log.warn("å¼€å‘æ¨¡å¼ï¼šé‚®ä»¶å‘é€å¤±è´¥ä½†è¿”å›æˆåŠŸï¼ŒéªŒè¯ç ä¸º: {}ï¼Œè¯·åœ¨å‰ç«¯æŸ¥çœ‹éªŒè¯ç ", code);
    return true; // âš ï¸ ç”Ÿäº§ç¯å¢ƒé£é™©
}
```
- **ç”Ÿäº§ç¯å¢ƒé£é™©**: é‚®ä»¶å‘é€å¤±è´¥ä½†è¿”å›æˆåŠŸï¼Œç”¨æˆ·ä»¥ä¸ºéªŒè¯ç å·²å‘é€ï¼Œä½†å®é™…æœªæ”¶åˆ°
- **æ— æ³•åŒºåˆ†çœŸå®çŠ¶æ€**: è°ƒç”¨æ–¹æ— æ³•çŸ¥é“é‚®ä»¶æ˜¯å¦çœŸçš„å‘é€æˆåŠŸ
- **å¼€å‘/ç”Ÿäº§æ— åŒºåˆ†**: æ²¡æœ‰æ ¹æ®ç¯å¢ƒå˜é‡åŒºåˆ†å¼€å‘å’Œç”Ÿäº§æ¨¡å¼

**å»ºè®®ä¿®å¤**:
```java
@Value("${spring.profiles.active:dev}")
private String activeProfile;

@Override
public boolean sendVerificationCode(String email, String code) {
    long startTime = System.currentTimeMillis();
    boolean sendSuccess = false;
    
    try {
        SimpleMailMessage message = new SimpleMailMessage();
        message.setTo(email);
        message.setSubject("TripDogéªŒè¯ç ");
        message.setText(buildEmailContent(code));
        message.setFrom(fromEmail);
        
        mailSender.send(message);
        sendSuccess = true;
        
        long duration = System.currentTimeMillis() - startTime;
        log.info("éªŒè¯ç é‚®ä»¶å‘é€æˆåŠŸ: email={}, è€—æ—¶={}ms", email, duration);
        return true;
        
    } catch (Exception e) {
        long duration = System.currentTimeMillis() - startTime;
        log.error("éªŒè¯ç é‚®ä»¶å‘é€å¤±è´¥: email={}, è€—æ—¶={}ms, error={}", email, duration, e.getMessage(), e);
        
        // å¼€å‘ç¯å¢ƒï¼šå…è®¸å¤±è´¥ä½†è¿”å›æˆåŠŸï¼ˆæ–¹ä¾¿æµ‹è¯•ï¼‰
        if ("dev".equals(activeProfile) || "test".equals(activeProfile)) {
            log.warn("å¼€å‘æ¨¡å¼ï¼šé‚®ä»¶å‘é€å¤±è´¥ä½†è¿”å›æˆåŠŸï¼ŒéªŒè¯ç ä¸º: {}ï¼Œè¯·åœ¨å‰ç«¯æŸ¥çœ‹éªŒè¯ç ", code);
            return true;
        }
        
        // ç”Ÿäº§ç¯å¢ƒï¼šè¿”å›å¤±è´¥
        return false;
    }
}
```

#### 4.2 EmailServiceImpl - éªŒè¯ç å­˜å‚¨åœ¨å†…å­˜ï¼ˆä¸­ç­‰ï¼‰
**ä½ç½®**: `EmailServiceImpl` (è¡Œ31)

**é—®é¢˜**:
```java
// ä½¿ç”¨å†…å­˜å­˜å‚¨éªŒè¯ç ï¼ˆç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨Redisï¼‰
private final ConcurrentHashMap<String, CodeInfo> codeStorage = new ConcurrentHashMap<>();
```
- **é‡å¯å³å¤±æ•ˆ**: åº”ç”¨é‡å¯åï¼Œæ‰€æœ‰éªŒè¯ç å¤±æ•ˆ
- **æ— æ³•åˆ†å¸ƒå¼**: å¤šå®ä¾‹éƒ¨ç½²æ—¶ï¼ŒéªŒè¯ç æ— æ³•å…±äº«
- **å†…å­˜æ³„æ¼é£é™©**: å¦‚æœéªŒè¯ç æœªåŠæ—¶æ¸…ç†ï¼Œå¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼

**å»ºè®®ä¿®å¤**:
```java
@Service
@RequiredArgsConstructor
@Slf4j
public class EmailServiceImpl implements EmailService {
    
    private final JavaMailSender mailSender;
    private final RedisService redisService; // æ³¨å…¥RedisService
    
    @Value("${spring.mail.username}")
    private String fromEmail;
    
    private static final String CODE_KEY_PREFIX = "email:code:";
    private static final int CODE_LENGTH = 6;
    private static final long CODE_EXPIRE_MINUTES = 5;
    
    @Override
    public String generateAndSendCode(String email) {
        String code = generateUniqueCode();
        String codeKey = CODE_KEY_PREFIX + code;
        
        // å­˜å‚¨åˆ°Redisï¼ˆå¸¦è¿‡æœŸæ—¶é—´ï¼‰
        CodeInfo codeInfo = new CodeInfo(email, System.currentTimeMillis() + TimeUnit.MINUTES.toMillis(CODE_EXPIRE_MINUTES));
        boolean stored = redisService.setObject(codeKey, codeInfo, CODE_EXPIRE_MINUTES, TimeUnit.MINUTES);
        
        if (!stored) {
            // Rediså¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°å†…å­˜ä½œä¸ºfallback
            log.warn("Redisä¸å¯ç”¨ï¼Œä½¿ç”¨æœ¬åœ°å†…å­˜å­˜å‚¨éªŒè¯ç : email={}", email);
            localCodeStorage.put(code, codeInfo);
        }
        
        // å¼‚æ­¥å‘é€é‚®ä»¶
        sendVerificationCodeAsync(email, code);
        return code;
    }
    
    @Override
    public boolean verifyCode(String email, String code) {
        String codeKey = CODE_KEY_PREFIX + code;
        
        // ä¼˜å…ˆä»Redisè·å–
        CodeInfo codeInfo = redisService.getObject(codeKey, CodeInfo.class);
        
        if (codeInfo == null) {
            // Redisä¸­æ²¡æœ‰ï¼Œå°è¯•ä»æœ¬åœ°å†…å­˜è·å–
            codeInfo = localCodeStorage.get(code);
        }
        
        if (codeInfo == null) {
            log.warn("éªŒè¯ç ä¸å­˜åœ¨: code={}", code);
            return false;
        }
        
        // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
        if (System.currentTimeMillis() > codeInfo.expireTime) {
            redisService.delete(codeKey);
            localCodeStorage.remove(code);
            log.warn("éªŒè¯ç å·²è¿‡æœŸ: code={}", code);
            return false;
        }
        
        // éªŒè¯é‚®ç®±æ˜¯å¦åŒ¹é…
        if (!codeInfo.email.equals(email)) {
            log.warn("éªŒè¯ç å¯¹åº”é‚®ç®±ä¸åŒ¹é…: code={}, expected={}, actual={}", code, codeInfo.email, email);
            return false;
        }
        
        // éªŒè¯æˆåŠŸååˆ é™¤éªŒè¯ç 
        redisService.delete(codeKey);
        localCodeStorage.remove(code);
        log.info("éªŒè¯ç éªŒè¯æˆåŠŸ: email={}, code={}", email, code);
        return true;
    }
}
```

---

## 5. AI æ¨¡å‹å’Œå¤–éƒ¨æœç´¢é—®é¢˜

### âŒ ä¸¥é‡é—®é¢˜

#### 5.1 AssistantService - æ— åˆå§‹åŒ–å¤±è´¥å¤„ç†ï¼ˆä¸¥é‡ï¼‰
**ä½ç½®**: `AssistantService.getAssistant()` (è¡Œ35-58)

**é—®é¢˜**:
```java
public ChatAssistant getAssistant() {
    EmbeddingStoreContentRetriever embeddingStoreContentRetriever = retrieverFactory.getRetriever();
    RetrievalAugmentor retrievalAugmentor = DefaultRetrievalAugmentor.builder()...build();
    McpClient mcpClient = mcpClientFactory.getMcpClient(WEB_SEARCH);
    // ...
    return AiServices.builder(ChatAssistant.class)
        .streamingChatModel(chatLanguageModel) // å¦‚æœä¸ºnullï¼Œå¯åŠ¨å¤±è´¥
        .retrievalAugmentor(retrievalAugmentor) // å¦‚æœå¤±è´¥ï¼Œå¯åŠ¨å¤±è´¥
        .toolProvider(toolProvider) // å¦‚æœmcpClientä¸ºnullï¼Œå¯èƒ½å¤±è´¥
        .build();
}
```
- **å¼ºä¾èµ–æ‰€æœ‰ç»„ä»¶**: å¦‚æœä»»ä½•ä¸€ä¸ªç»„ä»¶åˆå§‹åŒ–å¤±è´¥ï¼Œæ•´ä¸ªèŠå¤©åŠŸèƒ½ä¸å¯ç”¨
- **æ— é™çº§æ–¹æ¡ˆ**: æ— æ³•ç¦ç”¨æŸäº›åŠŸèƒ½ï¼ˆå¦‚å‘é‡æ£€ç´¢ã€MCPæœç´¢ï¼‰è€Œç»§ç»­ä½¿ç”¨åŸºç¡€èŠå¤©
- **å¯åŠ¨æ—¶å¤±è´¥**: å¦‚æœ StreamingChatModel Bean åˆå§‹åŒ–å¤±è´¥ï¼Œåº”ç”¨å¯åŠ¨å¤±è´¥

**å»ºè®®ä¿®å¤**:
```java
@Configuration
@RequiredArgsConstructor
@Slf4j
public class AssistantService {
    
    final StreamingChatModel chatLanguageModel;
    final RetrieverFactory retrieverFactory;
    final CustomerChatMemoryProvider chatMemoryProvider;
    final McpClientFactory mcpClientFactory;
    
    private volatile boolean retrievalEnabled = true;
    private volatile boolean mcpEnabled = true;
    
    @PostConstruct
    public void checkComponentsAvailability() {
        // æ£€æŸ¥å‘é‡æ£€ç´¢æ˜¯å¦å¯ç”¨
        try {
            retrieverFactory.getRetriever();
            retrievalEnabled = true;
            log.info("å‘é‡æ£€ç´¢åŠŸèƒ½å¯ç”¨");
        } catch (Exception e) {
            retrievalEnabled = false;
            log.warn("å‘é‡æ£€ç´¢åŠŸèƒ½ä¸å¯ç”¨ï¼Œå°†ç¦ç”¨RAGåŠŸèƒ½: {}", e.getMessage());
        }
        
        // æ£€æŸ¥MCPå®¢æˆ·ç«¯æ˜¯å¦å¯ç”¨
        try {
            McpClient mcpClient = mcpClientFactory.getMcpClient(WEB_SEARCH);
            mcpEnabled = (mcpClient != null);
            if (mcpEnabled) {
                log.info("MCPæœç´¢åŠŸèƒ½å¯ç”¨");
            } else {
                log.warn("MCPæœç´¢åŠŸèƒ½ä¸å¯ç”¨");
            }
        } catch (Exception e) {
            mcpEnabled = false;
            log.warn("MCPæœç´¢åŠŸèƒ½ä¸å¯ç”¨: {}", e.getMessage());
        }
    }
    
    public ChatAssistant getAssistant() {
        AiServices.AiServicesBuilder<ChatAssistant> builder = AiServices.builder(ChatAssistant.class)
            .streamingChatModel(chatLanguageModel)
            .chatMemoryProvider(chatMemoryProvider)
            .tools(new MyTools());
        
        // æ¡ä»¶æ€§æ·»åŠ å‘é‡æ£€ç´¢
        if (retrievalEnabled) {
            try {
                EmbeddingStoreContentRetriever retriever = retrieverFactory.getRetriever();
                RetrievalAugmentor retrievalAugmentor = DefaultRetrievalAugmentor.builder()
                    .contentRetriever(retriever)
                    .contentAggregator(new DefaultContentAggregator())
                    .contentInjector(DefaultContentInjector.builder()
                        .promptTemplate(PromptTemplate.from("{{userMessage}}" + INJECT_TEMPLATE + "{{contents}}"))
                        .build())
                    .build();
                builder.retrievalAugmentor(retrievalAugmentor);
                log.debug("å·²å¯ç”¨å‘é‡æ£€ç´¢åŠŸèƒ½");
            } catch (Exception e) {
                log.warn("å‘é‡æ£€ç´¢åˆå§‹åŒ–å¤±è´¥ï¼Œç¦ç”¨RAGåŠŸèƒ½: {}", e.getMessage());
            }
        }
        
        // æ¡ä»¶æ€§æ·»åŠ MCPå·¥å…·
        if (mcpEnabled) {
            try {
                McpClient mcpClient = mcpClientFactory.getMcpClient(WEB_SEARCH);
                if (mcpClient != null) {
                    McpToolProvider toolProvider = McpToolProvider.builder()
                        .mcpClients(mcpClient)
                        .build();
                    builder.toolProvider(toolProvider);
                    log.debug("å·²å¯ç”¨MCPæœç´¢åŠŸèƒ½");
                }
            } catch (Exception e) {
                log.warn("MCPå·¥å…·åˆå§‹åŒ–å¤±è´¥ï¼Œç¦ç”¨MCPåŠŸèƒ½: {}", e.getMessage());
            }
        }
        
        return builder.build();
    }
}
```

#### 5.2 McpClientFactory - è¿”å›nullä½†æ— æ£€æŸ¥ï¼ˆä¸­ç­‰ï¼‰
**ä½ç½®**: `McpClientFactory.getMcpClient()` (è¡Œ28-42)

**é—®é¢˜**:
```java
public McpClient getMcpClient(String k) {
    // ...
    switch (k) {
        case WEB_SEARCH:
            client = getWebSearchMcpClient();
            if (client != null) {
                map.put(k, client);
            }
            return client; // å¯èƒ½è¿”å›null
    }
    return null;
}
```
- **è¿”å›null**: å¦‚æœåˆå§‹åŒ–å¤±è´¥ï¼Œè¿”å›nullï¼Œä½†è°ƒç”¨æ–¹å¯èƒ½æœªæ£€æŸ¥
- **AssistantServiceä½¿ç”¨**: å¦‚æœè¿”å›nullï¼Œ`toolProvider` å¯èƒ½å¤±è´¥

**å½“å‰çŠ¶æ€**: å·²æœ‰try-catchï¼Œè¿”å›nullï¼Œä½† AssistantService éœ€è¦æ£€æŸ¥

---

## 6. å¥åº·æ£€æŸ¥å’Œå¯åŠ¨è‡ªæ£€

### âŒ ç¼ºå¤±åŠŸèƒ½

#### 6.1 æ— ä¾èµ–æœåŠ¡å¥åº·æ£€æŸ¥ï¼ˆä¸¥é‡ï¼‰
**é—®é¢˜**:
- **æ— å¯åŠ¨è‡ªæ£€**: åº”ç”¨å¯åŠ¨æ—¶ä¸ä¼šæ£€æŸ¥ MinIOã€Redisã€pgvectorã€DashScope æ˜¯å¦å¯ç”¨
- **æ— å¥åº·æ£€æŸ¥ç«¯ç‚¹**: `/actuator/health` å¯èƒ½ä¸åŒ…å«è¿™äº›ä¾èµ–çš„çŠ¶æ€
- **ç”¨æˆ·éš¾ä»¥å‘ç°é—®é¢˜**: åªæœ‰åœ¨ä½¿ç”¨æ—¶æ‰å‘ç°æœåŠ¡ä¸å¯ç”¨

**å»ºè®®å®ç°**:
```java
@Component
@RequiredArgsConstructor
@Slf4j
public class DependencyHealthChecker {
    
    private final MinioClient minioClient;
    private final MinioConfig minioConfig;
    private final RedisService redisService;
    private final EmbeddingStore<TextSegment> embeddingStore;
    private final StreamingChatModel chatLanguageModel;
    
    @PostConstruct
    public void checkDependencies() {
        log.info("å¼€å§‹æ£€æŸ¥ä¾èµ–æœåŠ¡å¥åº·çŠ¶æ€...");
        
        // æ£€æŸ¥MinIO
        checkMinIO();
        
        // æ£€æŸ¥Redis
        checkRedis();
        
        // æ£€æŸ¥pgvectorï¼ˆå¦‚æœé…ç½®ï¼‰
        checkPgVector();
        
        // æ£€æŸ¥DashScopeï¼ˆå¦‚æœé…ç½®ï¼‰
        checkDashScope();
        
        log.info("ä¾èµ–æœåŠ¡å¥åº·æ£€æŸ¥å®Œæˆ");
    }
    
    private void checkMinIO() {
        try {
            minioClient.listBuckets();
            log.info("âœ… MinIOè¿æ¥æ­£å¸¸");
        } catch (Exception e) {
            log.error("âŒ MinIOè¿æ¥å¤±è´¥: {}", e.getMessage());
            log.warn("âš ï¸  æ–‡ä»¶ä¸Šä¼ /ä¸‹è½½åŠŸèƒ½å¯èƒ½ä¸å¯ç”¨");
        }
    }
    
    private void checkRedis() {
        boolean available = redisService.set("health_check", "ok", 1, TimeUnit.SECONDS);
        if (available) {
            log.info("âœ… Redisè¿æ¥æ­£å¸¸");
        } else {
            log.error("âŒ Redisè¿æ¥å¤±è´¥");
            log.warn("âš ï¸  ç”¨æˆ·SessionåŠŸèƒ½å°†ä½¿ç”¨æœ¬åœ°å†…å­˜å­˜å‚¨");
        }
    }
    
    private void checkPgVector() {
        try {
            if (embeddingStore != null) {
                embeddingStore.findAll();
                log.info("âœ… PgVectorè¿æ¥æ­£å¸¸");
            } else {
                log.warn("âš ï¸  PgVectoræœªé…ç½®ï¼Œæ–‡æ¡£å‘é‡åŒ–åŠŸèƒ½ä¸å¯ç”¨");
            }
        } catch (Exception e) {
            log.error("âŒ PgVectorè¿æ¥å¤±è´¥: {}", e.getMessage());
            log.warn("âš ï¸  æ–‡æ¡£å‘é‡åŒ–åŠŸèƒ½ä¸å¯ç”¨");
        }
    }
    
    private void checkDashScope() {
        try {
            if (chatLanguageModel != null) {
                // å°è¯•ä¸€ä¸ªç®€å•çš„è°ƒç”¨
                log.info("âœ… DashScopeæ¨¡å‹å¯ç”¨");
            } else {
                log.warn("âš ï¸  DashScopeæœªé…ç½®ï¼ŒAIèŠå¤©åŠŸèƒ½ä¸å¯ç”¨");
            }
        } catch (Exception e) {
            log.error("âŒ DashScopeè¿æ¥å¤±è´¥: {}", e.getMessage());
            log.warn("âš ï¸  AIèŠå¤©åŠŸèƒ½ä¸å¯ç”¨");
        }
    }
}
```

#### 6.2 Actuator å¥åº·æ£€æŸ¥ä¸å®Œæ•´ï¼ˆä¸­ç­‰ï¼‰
**é—®é¢˜**:
- **å¯èƒ½ä¸åŒ…å«è‡ªå®šä¹‰ä¾èµ–**: Spring Boot Actuator é»˜è®¤åªæ£€æŸ¥æ•°æ®åº“ã€Redisç­‰æ ‡å‡†ç»„ä»¶
- **MinIOã€pgvectorã€DashScope å¯èƒ½ä¸åœ¨å¥åº·æ£€æŸ¥ä¸­**

**å»ºè®®**: å®ç°è‡ªå®šä¹‰ HealthIndicator

```java
@Component
@RequiredArgsConstructor
public class MinioHealthIndicator implements HealthIndicator {
    
    private final MinioClient minioClient;
    private final MinioConfig minioConfig;
    
    @Override
    public Health health() {
        try {
            minioClient.listBuckets();
            return Health.up()
                .withDetail("bucket", minioConfig.getBucketName())
                .build();
        } catch (Exception e) {
            return Health.down()
                .withDetail("error", e.getMessage())
                .build();
        }
    }
}
```

---

## 7. å…¶ä»–å‘ç°çš„é—®é¢˜

### 7.1 DocController - ä¸Šä¼ æ¥å£çš„å¼‚å¸¸å¤„ç†ä¸å¤Ÿç»†è‡´ï¼ˆä¸­ç­‰ï¼‰
**ä½ç½®**: `DocController.upload()` (è¡Œ141-143)

**é—®é¢˜**:
```java
} catch (Exception e) {
    log.error("æ–‡æ¡£ä¸Šä¼ å¤„ç†å¼‚å¸¸", e);
    return Result.error(ErrorCode.SYSTEM_ERROR); // ç»Ÿä¸€è¿”å›ç³»ç»Ÿé”™è¯¯
}
```
- **é”™è¯¯ä¿¡æ¯ä¸æ˜ç¡®**: æ— æ³•åŒºåˆ†æ˜¯ MinIO å¤±è´¥ã€æ•°æ®åº“å¤±è´¥è¿˜æ˜¯å‘é‡åŒ–å¤±è´¥
- **ç”¨æˆ·æ— æ³•çŸ¥é“å…·ä½“åŸå› **: åªçŸ¥é“"ç³»ç»Ÿé”™è¯¯"

**å»ºè®®**: æ ¹æ®å¼‚å¸¸ç±»å‹è¿”å›ä¸åŒçš„é”™è¯¯ç 

### 7.2 ChatServiceImpl - æ—  Assistant åˆå§‹åŒ–å¤±è´¥å¤„ç†ï¼ˆä¸­ç­‰ï¼‰
**ä½ç½®**: `ChatServiceImpl.chat()` (è¡Œ68)

**é—®é¢˜**:
```java
ChatAssistant assistant = assistantService.getAssistant();
// å¦‚æœgetAssistant()å¤±è´¥ï¼Œæ•´ä¸ªèŠå¤©åŠŸèƒ½ä¸å¯ç”¨
```
- **æ— é™çº§æ–¹æ¡ˆ**: å¦‚æœ Assistant åˆå§‹åŒ–å¤±è´¥ï¼Œæ— æ³•ä½¿ç”¨åŸºç¡€èŠå¤©åŠŸèƒ½

---

## ğŸ“Š é—®é¢˜ç»Ÿè®¡

| ç±»åˆ« | ä¸¥é‡é—®é¢˜ | ä¸­ç­‰é—®é¢˜ | è½»å¾®é—®é¢˜ | æ€»è®¡ |
|------|---------|---------|---------|------|
| MinIO | 2 | 2 | 0 | 4 |
| PgVector | 3 | 0 | 0 | 3 |
| Redis/ä¼šè¯ | 2 | 0 | 0 | 2 |
| é‚®ä»¶æœåŠ¡ | 2 | 0 | 0 | 2 |
| AIæ¨¡å‹/æœç´¢ | 1 | 1 | 0 | 2 |
| å¥åº·æ£€æŸ¥ | 1 | 1 | 0 | 2 |
| å…¶ä»– | 0 | 2 | 0 | 2 |
| **æ€»è®¡** | **11** | **6** | **0** | **17** |

---

## ğŸ¯ ä¿®å¤ä¼˜å…ˆçº§

### P0 - ç«‹å³ä¿®å¤ï¼ˆå½±å“æ ¸å¿ƒåŠŸèƒ½ï¼‰
1. âœ… DocController ä¸‹è½½æ¥å£æ— å®¹é”™
2. âœ… DocController åˆ é™¤æ¥å£æ— å®¹é”™
3. âœ… VectorDataService æ‰€æœ‰æ–¹æ³•ç›´æ¥æŠ›å‡ºå¼‚å¸¸
4. âœ… RedisService å¼‚å¸¸è¢«åæ‰
5. âœ… UserSessionService æ— æœ¬åœ° Fallback

### P1 - é«˜ä¼˜å…ˆçº§ï¼ˆå½±å“ç”¨æˆ·ä½“éªŒï¼‰
6. âœ… EmailServiceImpl å‘é€å¤±è´¥ä»è¿”å›æˆåŠŸï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
7. âœ… DocController ä¸Šä¼ æ¥å£å¼ºä¾èµ–å‘é‡åŒ–
8. âœ… AssistantService æ— åˆå§‹åŒ–å¤±è´¥å¤„ç†

### P2 - ä¸­ä¼˜å…ˆçº§ï¼ˆå»ºè®®ä¿®å¤ï¼‰
9. âœ… FileUploadUtils åˆ é™¤å’Œè·å–URLæ–¹æ³•
10. âœ… EmailServiceImpl éªŒè¯ç å­˜å‚¨åœ¨å†…å­˜
11. âœ… PgVectorEmbeddingStoreInit Bean åˆå§‹åŒ–æ— å®¹é”™
12. âœ… æ— ä¾èµ–æœåŠ¡å¥åº·æ£€æŸ¥

### P3 - ä½ä¼˜å…ˆçº§ï¼ˆå¯é€‰ä¼˜åŒ–ï¼‰
13. âœ… DocController å¼‚å¸¸å¤„ç†ä¸å¤Ÿç»†è‡´
14. âœ… ChatServiceImpl æ—  Assistant åˆå§‹åŒ–å¤±è´¥å¤„ç†
15. âœ… Actuator å¥åº·æ£€æŸ¥ä¸å®Œæ•´

---

## ğŸ“ æ€»ç»“

å¯¹æ¯”ç”¨æˆ·æä¾›çš„æ’æŸ¥æ€»ç»“ï¼Œå‘ç°çš„é—®é¢˜åŸºæœ¬ä¸€è‡´ï¼Œä½†æœ‰ä¸€äº›é¢å¤–çš„å‘ç°ï¼š

1. **FileUploadUtils çš„å·¥å…·æ–¹æ³•**ä¹Ÿéœ€è¦å®¹é”™å¤„ç†
2. **å¥åº·æ£€æŸ¥æœºåˆ¶**å®Œå…¨ç¼ºå¤±ï¼Œéœ€è¦æ·»åŠ å¯åŠ¨è‡ªæ£€
3. **é”™è¯¯ä¿¡æ¯ä¸å¤Ÿæ˜ç¡®**ï¼Œéœ€è¦åŒºåˆ†ä¸åŒç±»å‹çš„é”™è¯¯

**å»ºè®®ä¿®å¤é¡ºåº**:
1. å…ˆä¿®å¤ P0 é—®é¢˜ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰
2. å†ä¿®å¤ P1 é—®é¢˜ï¼ˆç”¨æˆ·ä½“éªŒï¼‰
3. æœ€åä¿®å¤ P2/P3 é—®é¢˜ï¼ˆå®Œå–„æ€§ï¼‰

**é¢„è®¡ä¿®å¤æ—¶é—´**:
- P0: 2-3å°æ—¶
- P1: 1-2å°æ—¶
- P2: 1å°æ—¶
- P3: 30åˆ†é’Ÿ

**æ€»è®¡**: çº¦ 4-6 å°æ—¶


