# DeepSeek 配置问题排查和修复总结

**日期**: 2025-11-24

---

## 问题链路线性排查

### 问题1：MCP 配置缺失
**错误**: `Could not resolve placeholder 'mcp.search-link'`

**根因**: `application.yaml` 中缺少 `mcp.search-link` 配置

**修复**:
1. 在 `application.yaml` 中添加 `mcp.search-link: ""` 默认配置
2. 修改 `@Value` 注解为 `@Value("${mcp.search-link:#{''}}")` 使用 SpEL 表达式

### 问题2：MinIO Endpoint 重复拼接
**错误**: `no path allowed in endpoint http://http//localhost:9000:9000`

**根因**: 
- 环境变量 `MINIO_ENDPOINT` 设置为 `http://localhost:9000`（包含协议）
- `MinioConfig.java` 中又拼接了 `"http://" + endpoint + ":" + port`
- 导致重复：`http://http://localhost:9000:9000`

**修复**:
1. 修改 `MinioConfig.java`，检测 endpoint 是否已包含协议
2. 如果已包含协议，直接使用；否则拼接协议和端口
3. 环境变量设置：`MINIO_ENDPOINT=localhost`（不包含协议）

### 问题3：默认 Profile 需要 DashScope API Key
**错误**: `Could not resolve placeholder 'DASHSCOPE_API_KEY'`

**根因**: 
- `application.yaml:5` 默认 profile 是 `ai`
- `application-ai.yaml` 需要 `DASHSCOPE_API_KEY` 环境变量

**修复**:
- 设置 `SPRING_PROFILES_ACTIVE=deepseek` 使用 DeepSeek profile

---

## 完整修复清单

### ✅ 1. MCP 配置修复
- [x] `application.yaml` 添加 `mcp.search-link: ""`
- [x] `McpClientFactory.java` 修改为 `@Value("${mcp.search-link:#{''}}")`
- [x] `getWebSearchMcpClient()` 添加空值检查

### ✅ 2. MinIO 配置修复
- [x] `MinioConfig.java` 修复 endpoint 重复拼接问题
- [x] 支持 endpoint 包含协议的情况
- [x] 环境变量设置：`MINIO_ENDPOINT=localhost`（不包含协议）

### ✅ 3. Profile 配置
- [x] 使用 `SPRING_PROFILES_ACTIVE=deepseek` 避免 DashScope 依赖
- [x] 创建 `start-backend-deepseek.sh` 启动脚本

### ✅ 4. DeepSeek Bean 配置
- [x] `DeepSeekConfig.java` - StreamingChatModel Bean
- [x] `DeepSeekChatModelConfig.java` - ChatModel Bean
- [x] `DeepSeekEmbeddingStoreConfig.java` - EmbeddingStore 和 EmbeddingModel Bean

### ✅ 5. PgVector 配置
- [x] `PgVectorEmbeddingStoreInit` 添加 `@ConditionalOnProperty`，仅在 `ai` profile 启用

---

## 正确的启动方式

### 方法1：使用启动脚本（推荐）

```bash
cd /projects/trip_doge
./start-backend-deepseek.sh
```

### 方法2：手动设置环境变量

```bash
cd /projects/trip_doge

export DEEPSEEK_API_KEY="sk-your-deepseek-api-key"
export SPRING_PROFILES_ACTIVE="deepseek"
export MYSQL_HOST="localhost"
export MYSQL_DATABASE="trip_dog"
export MYSQL_USERNAME="root"
export MYSQL_PASSWORD=""
export REDIS_HOST="localhost"
export REDIS_PORT="6379"
export REDIS_DATABASE="0"
export REDIS_PASSWORD=""
export MINIO_ENDPOINT="localhost"  # 注意：不包含协议
export MINIO_PORT="9000"
export MINIO_AK="minioadmin"
export MINIO_SK="minioadmin"

mvn spring-boot:run
```

---

## 关键配置说明

### MinIO Endpoint 配置
- ❌ **错误**: `MINIO_ENDPOINT="http://localhost:9000"`
- ✅ **正确**: `MINIO_ENDPOINT="localhost"`（代码会自动拼接协议和端口）

### Profile 选择
- **deepseek**: 使用 DeepSeek API，不需要 DashScope API Key
- **ai**: 使用 DashScope API，需要 `DASHSCOPE_API_KEY`

### MCP 配置
- 默认值：`mcp.search-link: ""`（空字符串，MCP 功能禁用）
- 如果需要 MCP 功能，设置 `SEARCH_MCP_LINK` 环境变量

---

## 验证服务启动

等待约90-120秒后：

```bash
# 检查健康状态
curl http://localhost:7979/api/actuator/health

# 应该返回：
# {"status":"UP"}
```

---

## 总结

所有配置问题已修复：
1. ✅ MCP 配置问题已解决
2. ✅ MinIO endpoint 重复问题已解决
3. ✅ Profile 配置问题已解决
4. ✅ DeepSeek Bean 配置已完成

**下一步**: 使用 `./start-backend-deepseek.sh` 启动服务，或按照上述方法2手动设置环境变量后启动。



