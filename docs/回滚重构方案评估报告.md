# å›æ»š+é‡æ„æ–¹æ¡ˆè¯„ä¼°æŠ¥å‘Š

**è¯„ä¼°æ—¶é—´**: 2025-11-24  
**è¯„ä¼°äºº**: AIæŠ€æœ¯è´Ÿè´£äºº

---

## ğŸ“‹ æ–¹æ¡ˆæ€»ä½“è¯„ä¼°

### âœ… æ–¹æ¡ˆä¼˜ç‚¹

1. **æ€è·¯æ¸…æ™°ï¼Œç¬¦åˆè½¯ä»¶å·¥ç¨‹æœ€ä½³å®è·µ**
   - å…ˆå›æ»šåˆ°ç¨³å®šåŸºçº¿ï¼Œç¡®ä¿æ ¸å¿ƒåŠŸèƒ½å¯ç”¨
   - å†é€æ­¥é‡æ„ï¼Œé™ä½é£é™©
   - é‡‡ç”¨å¯æ’æ‹”æ¶æ„ï¼Œæå‡å¯ç»´æŠ¤æ€§

2. **è§£å†³æ ¸å¿ƒç—›ç‚¹**
   - âœ… è§£å†³"æ— API Keyæ— æ³•å¯åŠ¨"çš„é—®é¢˜
   - âœ… ç»Ÿä¸€LLMæ¥å…¥å±‚ï¼Œæ¶ˆé™¤profileæ··ä¹±
   - âœ… é™ä½å¤–éƒ¨ä¾èµ–çš„è€¦åˆåº¦

3. **æ¶æ„è®¾è®¡åˆç†**
   - æ¥å£æŠ½è±¡ + å·¥å‚æ¨¡å¼ï¼Œç¬¦åˆå¼€é—­åŸåˆ™
   - Mock Providerä½œä¸ºfallbackï¼Œä¿è¯å¼€å‘ä½“éªŒ
   - é…ç½®ç®€åŒ–ï¼Œé™ä½ä½¿ç”¨é—¨æ§›

---

## âš ï¸ æ½œåœ¨é£é™©ä¸æ³¨æ„äº‹é¡¹

### 1. å›æ»šç­–ç•¥é£é™©

**é£é™©ç‚¹**ï¼š
- `c6cb9ab` ä¹‹å‰çš„commitå¯èƒ½ä¸åŒ…å«æŸäº›å¿…è¦çš„å‰ç«¯åŠŸèƒ½
- å›æ»šå¯èƒ½ä¸¢å¤±é‡è¦çš„bugä¿®å¤

**å»ºè®®**ï¼š
```bash
# 1. å…ˆç¡®è®¤ç¨³å®šcommit
git log --oneline --all | grep -E "feat|fix|refactor" | head -20

# 2. æ£€æŸ¥è¯¥commitæ˜¯å¦åŒ…å«æ ¸å¿ƒåŠŸèƒ½ï¼ˆç™»å½•ã€è§’è‰²ã€èŠå¤©ï¼‰
git show c6cb9ab --stat

# 3. å»ºè®®ä½¿ç”¨æ›´ä¿å®ˆçš„å›æ»šç­–ç•¥ï¼š
#    ä¸ç›´æ¥resetï¼Œè€Œæ˜¯åˆ›å»ºæ–°åˆ†æ”¯ï¼Œé€‰æ‹©æ€§cherry-pickéœ€è¦çš„commit
```

### 2. é‡æ„å¤æ‚åº¦è¯„ä¼°

**å½“å‰ä¾èµ–å…³ç³»**ï¼š
- `ChatServiceImpl` â†’ `StreamingChatModel`ï¼ˆç›´æ¥ä¾èµ–ï¼‰
- `AssistantService` â†’ `StreamingChatModel`ï¼ˆç›´æ¥ä¾èµ–ï¼‰
- `CompressAssistantConfig` â†’ `ChatModel`ï¼ˆç›´æ¥ä¾èµ–ï¼‰
- `RetrieverFactory` â†’ `EmbeddingStore` + `EmbeddingModel`ï¼ˆç›´æ¥ä¾èµ–ï¼‰

**é‡æ„å·¥ä½œé‡**ï¼š
- éœ€è¦ä¿®æ”¹çš„æœåŠ¡ç±»ï¼š3-5ä¸ª
- éœ€è¦åˆ›å»ºçš„æ¥å£/å®ç°ï¼š6-8ä¸ªç±»
- é…ç½®ç±»è°ƒæ•´ï¼š4-6ä¸ª

**é¢„ä¼°æ—¶é—´**ï¼š2-3å¤©ï¼ˆåŒ…å«æµ‹è¯•ï¼‰

### 3. å¤–éƒ¨ä¾èµ–å¯é€‰åŒ–é£é™©

**å½“å‰å¼ºä¾èµ–**ï¼š
- Redisï¼ˆSessionå­˜å‚¨ï¼‰
- MinIOï¼ˆæ–‡ä»¶å­˜å‚¨ï¼‰
- PgVectorï¼ˆå‘é‡å­˜å‚¨ï¼‰

**é£é™©**ï¼š
- å¦‚æœè¿™äº›ä¾èµ–å˜æˆå¯é€‰ï¼Œéœ€è¦å®ç°fallbackæœºåˆ¶
- å¯èƒ½å½±å“ç°æœ‰åŠŸèƒ½çš„å®Œæ•´æ€§

**å»ºè®®**ï¼š
- **é˜¶æ®µ1**ï¼šå…ˆè®©LLM Providerå¯é€‰ï¼Œå…¶ä»–ä¾èµ–ä¿æŒå¿…éœ€
- **é˜¶æ®µ2**ï¼šå†é€æ­¥å°†Redis/MinIO/PgVectoræ”¹ä¸ºå¯é€‰

---

## ğŸ¯ æ”¹è¿›å»ºè®®

### 1. å›æ»šç­–ç•¥ä¼˜åŒ–

**åŸæ–¹æ¡ˆ**ï¼š
```bash
git switch -c refactor/llm-provider <ç¨³å®šcommit>
```

**æ”¹è¿›æ–¹æ¡ˆ**ï¼š
```bash
# 1. åˆ›å»ºå¤‡ä»½åˆ†æ”¯ï¼ˆä¿ç•™å½“å‰å·¥ä½œï¼‰
git branch backup/current-state

# 2. åˆ›å»ºé‡æ„åˆ†æ”¯ï¼ˆä»ç¨³å®šcommitï¼‰
git checkout -b refactor/llm-provider c6cb9ab

# 3. é€‰æ‹©æ€§cherry-pickå¿…è¦çš„ä¿®å¤
git cherry-pick <bug-fix-commit-1>
git cherry-pick <bug-fix-commit-2>

# 4. éªŒè¯æ ¸å¿ƒåŠŸèƒ½å¯ç”¨
mvn test
```

### 2. æ¥å£è®¾è®¡ä¼˜åŒ–

**åŸæ–¹æ¡ˆæ¥å£**ï¼š
```java
interface LLMClient {
    streamChat(request)
    chat(request)
    embed(texts)
}
```

**æ”¹è¿›å»ºè®®**ï¼š
```java
// 1. æ ¸å¿ƒæ¥å£ï¼ˆå¿…éœ€ï¼‰
public interface LLMClient {
    StreamingResponse streamChat(ChatRequest request);
    ChatResponse chat(ChatRequest request);
}

// 2. æ‰©å±•æ¥å£ï¼ˆå¯é€‰ï¼‰
public interface EmbeddingClient {
    List<Embedding> embed(List<String> texts);
}

// 3. å·¥å…·è°ƒç”¨æ¥å£ï¼ˆå¯é€‰ï¼‰
public interface ToolCallingClient {
    ToolResponse callTool(ToolRequest request);
}

// 4. ç»Ÿä¸€é…ç½®
public interface LLMProviderConfig {
    String getProviderName();
    String getApiKey();
    Duration getTimeout();
    boolean supportsEmbedding();
    boolean supportsToolCalling();
}
```

### 3. é…ç½®ç®€åŒ–æ–¹æ¡ˆ

**åŸæ–¹æ¡ˆ**ï¼š
```yaml
llm:
  provider: dashscope|deepseek|mock
  dashscope:
    api-key: ${DASHSCOPE_API_KEY}
  deepseek:
    api-key: ${DEEPSEEK_API_KEY}
```

**æ”¹è¿›æ–¹æ¡ˆ**ï¼š
```yaml
# application.yamlï¼ˆé»˜è®¤é…ç½®ï¼‰
llm:
  provider: mock  # é»˜è®¤mockï¼Œä¿è¯æ— Keyä¹Ÿèƒ½å¯åŠ¨
  enabled: true   # å¯ä»¥å®Œå…¨ç¦ç”¨LLMåŠŸèƒ½

# application-llm.yamlï¼ˆLLMåŠŸèƒ½é…ç½®ï¼Œå¯é€‰ï¼‰
llm:
  provider: dashscope
  dashscope:
    api-key: ${DASHSCOPE_API_KEY}
    model-name: qwen3-max
  deepseek:
    api-key: ${DEEPSEEK_API_KEY}
    model-name: deepseek-chat
```

### 4. BeanåŠ è½½ç­–ç•¥ä¼˜åŒ–

**åŸæ–¹æ¡ˆ**ï¼š
```java
@ConditionalOnProperty(prefix="llm", name="provider", havingValue="dashscope")
```

**æ”¹è¿›æ–¹æ¡ˆ**ï¼š
```java
// 1. ç»Ÿä¸€å·¥å‚ç±»
@Configuration
public class LLMClientFactory {
    @Bean
    @ConditionalOnProperty(name = "llm.provider", havingValue = "dashscope")
    public LLMClient dashscopeClient(LLMProviderConfig config) { ... }
    
    @Bean
    @ConditionalOnProperty(name = "llm.provider", havingValue = "deepseek")
    public LLMClient deepseekClient(LLMProviderConfig config) { ... }
    
    @Bean
    @ConditionalOnProperty(name = "llm.provider", havingValue = "mock", matchIfMissing = true)
    public LLMClient mockClient() { ... }
}

// 2. ä¸»Beanï¼ˆæ ¹æ®é…ç½®è‡ªåŠ¨é€‰æ‹©ï¼‰
@Bean
@Primary
public LLMClient llmClient(LLMClientFactory factory) {
    return factory.getClient();
}
```

---

## ğŸ“ è¯¦ç»†å®æ–½è®¡åˆ’

### é˜¶æ®µAï¼šå›æ»šä¸éªŒè¯ï¼ˆ1å¤©ï¼‰

#### A1. å›æ»šå‡†å¤‡
```bash
# 1. å¤‡ä»½å½“å‰çŠ¶æ€
git branch backup/pre-refactor-$(date +%Y%m%d)

# 2. ç¡®è®¤ç¨³å®šcommit
git log --oneline | grep -E "feat.*login|feat.*role|feat.*chat" | head -5

# 3. åˆ›å»ºé‡æ„åˆ†æ”¯
git checkout -b refactor/llm-provider c6cb9ab
```

#### A2. éªŒè¯æ ¸å¿ƒåŠŸèƒ½
- [ ] åç«¯å¯ä»¥æ— API Keyå¯åŠ¨
- [ ] ç™»å½•åŠŸèƒ½æ­£å¸¸
- [ ] è§’è‰²åˆ—è¡¨åŠŸèƒ½æ­£å¸¸
- [ ] åŸºç¡€èŠå¤©åŠŸèƒ½æ­£å¸¸ï¼ˆä½¿ç”¨Mockï¼‰

### é˜¶æ®µBï¼šæ¥å£æŠ½è±¡ï¼ˆ1å¤©ï¼‰

#### B1. åˆ›å»ºæ ¸å¿ƒæ¥å£
```
src/main/java/com/tripdog/ai/provider/
â”œâ”€â”€ LLMClient.java              # æ ¸å¿ƒæ¥å£
â”œâ”€â”€ LLMProviderConfig.java      # é…ç½®æ¥å£
â”œâ”€â”€ ChatRequest.java            # è¯·æ±‚DTO
â”œâ”€â”€ ChatResponse.java           # å“åº”DTO
â””â”€â”€ StreamingResponse.java      # æµå¼å“åº”
```

#### B2. åˆ›å»ºMockå®ç°
```
src/main/java/com/tripdog/ai/provider/mock/
â”œâ”€â”€ MockLLMClient.java          # Mockå®ç°
â””â”€â”€ MockLLMClientConfig.java    # Mocké…ç½®
```

#### B3. ä¿®æ”¹ä¸šåŠ¡å±‚
- [ ] `ChatServiceImpl` æ”¹ä¸ºä¾èµ– `LLMClient`
- [ ] `AssistantService` æ”¹ä¸ºä¾èµ– `LLMClient`
- [ ] `CompressAssistantConfig` æ”¹ä¸ºä¾èµ– `LLMClient`

### é˜¶æ®µCï¼šProviderå®ç°ï¼ˆ1-2å¤©ï¼‰

#### C1. DashScope Provider
```
src/main/java/com/tripdog/ai/provider/dashscope/
â”œâ”€â”€ DashScopeLLMClient.java
â””â”€â”€ DashScopeLLMClientConfig.java
```

#### C2. DeepSeek Provider
```
src/main/java/com/tripdog/ai/provider/deepseek/
â”œâ”€â”€ DeepSeekLLMClient.java
â””â”€â”€ DeepSeekLLMClientConfig.java
```

#### C3. å·¥å‚ç±»
```
src/main/java/com/tripdog/ai/provider/
â””â”€â”€ LLMClientFactory.java       # æ ¹æ®é…ç½®é€‰æ‹©Provider
```

### é˜¶æ®µDï¼šé…ç½®ç®€åŒ–ï¼ˆ0.5å¤©ï¼‰

#### D1. é…ç½®æ–‡ä»¶è°ƒæ•´
- [ ] ç®€åŒ– `application.yaml`ï¼ˆç§»é™¤profileä¾èµ–ï¼‰
- [ ] åˆ›å»º `application-llm.yaml`ï¼ˆå¯é€‰ï¼‰
- [ ] åˆ é™¤ `application-ai.yaml` å’Œ `application-deepseek.yaml`

#### D2. Beané…ç½®è°ƒæ•´
- [ ] ç§»é™¤æ‰€æœ‰ `@ConditionalOnProperty(name = "spring.profiles.active", ...)`
- [ ] ç»Ÿä¸€ä½¿ç”¨ `@ConditionalOnProperty(prefix="llm", name="provider", ...)`

### é˜¶æ®µEï¼šæµ‹è¯•ä¸æ–‡æ¡£ï¼ˆ0.5å¤©ï¼‰

#### E1. å•å…ƒæµ‹è¯•
- [ ] Mock Provideræµ‹è¯•
- [ ] DashScope Provideræµ‹è¯•
- [ ] DeepSeek Provideræµ‹è¯•
- [ ] Factoryæµ‹è¯•

#### E2. é›†æˆæµ‹è¯•
- [ ] æ— API Keyå¯åŠ¨æµ‹è¯•
- [ ] åˆ‡æ¢Provideræµ‹è¯•
- [ ] ç«¯åˆ°ç«¯åŠŸèƒ½æµ‹è¯•

#### E3. æ–‡æ¡£æ›´æ–°
- [ ] READMEæ›´æ–°
- [ ] é…ç½®æŒ‡å—æ›´æ–°
- [ ] è¿ç§»æŒ‡å—

---

## ğŸ” å…³é”®æŠ€æœ¯ç»†èŠ‚

### 1. Mock Providerå®ç°

```java
@Component
@ConditionalOnProperty(name = "llm.provider", havingValue = "mock", matchIfMissing = true)
public class MockLLMClient implements LLMClient {
    @Override
    public StreamingResponse streamChat(ChatRequest request) {
        // è¿”å›æ¨¡æ‹Ÿçš„æµå¼å“åº”
        return StreamingResponse.builder()
            .content("è¿™æ˜¯Mockå“åº”ï¼š" + request.getMessage())
            .build();
    }
    
    @Override
    public ChatResponse chat(ChatRequest request) {
        return ChatResponse.builder()
            .content("è¿™æ˜¯Mockå“åº”ï¼š" + request.getMessage())
            .build();
    }
}
```

### 2. é…ç½®ç±»è®¾è®¡

```java
@ConfigurationProperties(prefix = "llm")
public class LLMProviderConfig {
    private String provider = "mock";
    private DashScopeConfig dashscope;
    private DeepSeekConfig deepseek;
    
    // getters and setters
}
```

### 3. å·¥å‚ç±»å®ç°

```java
@Configuration
public class LLMClientFactory {
    private final LLMProviderConfig config;
    private final ApplicationContext context;
    
    @Bean
    @Primary
    public LLMClient llmClient() {
        String provider = config.getProvider();
        switch (provider) {
            case "dashscope":
                return context.getBean(DashScopeLLMClient.class);
            case "deepseek":
                return context.getBean(DeepSeekLLMClient.class);
            case "mock":
            default:
                return context.getBean(MockLLMClient.class);
        }
    }
}
```

---

## âœ… æ–¹æ¡ˆå¯è¡Œæ€§ç»“è®º

### æ€»ä½“è¯„ä»·ï¼š**é«˜åº¦å¯è¡Œï¼Œå¼ºçƒˆæ¨è**

**ç†ç”±**ï¼š
1. âœ… æ–¹æ¡ˆè®¾è®¡åˆç†ï¼Œç¬¦åˆè½¯ä»¶å·¥ç¨‹æœ€ä½³å®è·µ
2. âœ… è§£å†³æ ¸å¿ƒç—›ç‚¹ï¼ˆæ— Keyæ— æ³•å¯åŠ¨ï¼‰
3. âœ… æ¶æ„æ¸…æ™°ï¼Œæ˜“äºæ‰©å±•
4. âœ… é£é™©å¯æ§ï¼Œå¯ä»¥åˆ†é˜¶æ®µå®æ–½

**å»ºè®®æ‰§è¡Œé¡ºåº**ï¼š
1. **ç«‹å³æ‰§è¡Œ**ï¼šé˜¶æ®µAï¼ˆå›æ»šä¸éªŒè¯ï¼‰
2. **ä¼˜å…ˆæ‰§è¡Œ**ï¼šé˜¶æ®µBï¼ˆæ¥å£æŠ½è±¡ï¼‰+ Mockå®ç°
3. **é€æ­¥æ‰§è¡Œ**ï¼šé˜¶æ®µCï¼ˆProviderå®ç°ï¼‰
4. **æœ€åæ‰§è¡Œ**ï¼šé˜¶æ®µDï¼ˆé…ç½®ç®€åŒ–ï¼‰+ é˜¶æ®µEï¼ˆæµ‹è¯•ï¼‰

---

## ğŸ“Œ æ³¨æ„äº‹é¡¹

1. **ä¸è¦ä¸€æ¬¡æ€§é‡æ„æ‰€æœ‰ä»£ç **ï¼Œåˆ†é˜¶æ®µè¿›è¡Œ
2. **ä¿æŒå‘åå…¼å®¹**ï¼Œç¡®ä¿ç°æœ‰åŠŸèƒ½ä¸å—å½±å“
3. **å……åˆ†æµ‹è¯•**ï¼Œæ¯ä¸ªé˜¶æ®µéƒ½è¦éªŒè¯åŠŸèƒ½æ­£å¸¸
4. **ä¿ç•™å¤‡ä»½**ï¼Œå›æ»šå‰ä¸€å®šè¦åˆ›å»ºå¤‡ä»½åˆ†æ”¯
5. **æ–‡æ¡£åŒæ­¥**ï¼ŒåŠæ—¶æ›´æ–°é…ç½®æ–‡æ¡£å’ŒREADME

---

## ğŸ¯ é¢„æœŸæ”¶ç›Š

1. **å¼€å‘ä½“éªŒæå‡**ï¼šæ— API Keyä¹Ÿèƒ½å¯åŠ¨ï¼Œé™ä½å¼€å‘é—¨æ§›
2. **æ¶æ„æ¸…æ™°**ï¼šç»Ÿä¸€çš„LLMæ¥å…¥å±‚ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•
3. **é…ç½®ç®€åŒ–**ï¼šä¸å†ä¾èµ–å¤æ‚çš„profileé…ç½®
4. **æ‰©å±•æ€§å¼º**ï¼šæ–°å¢Provideråªéœ€å®ç°æ¥å£ï¼Œæ— éœ€ä¿®æ”¹ä¸šåŠ¡ä»£ç 

---

**è¯„ä¼°å®Œæˆæ—¶é—´**: 2025-11-24  
**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**: ç­‰å¾…ç¡®è®¤åå¼€å§‹æ‰§è¡Œé˜¶æ®µA

