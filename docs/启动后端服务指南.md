# 启动后端服务指南

## 问题说明

默认情况下，Spring Boot 使用 `ai` profile（见 `application.yaml:5`），该 profile 需要 `DASHSCOPE_API_KEY` 环境变量。如果没有设置，服务会启动失败。

## 解决方案

### 方案1：使用 DeepSeek Profile（推荐用于测试）

```bash
cd /projects/trip_doge

# 设置环境变量
export DEEPSEEK_API_KEY="sk-your-deepseek-api-key"
export SPRING_PROFILES_ACTIVE="deepseek"
export MYSQL_HOST="localhost"
export MYSQL_DATABASE="trip_dog"
export MYSQL_USERNAME="root"
export MYSQL_PASSWORD=""
export REDIS_HOST="localhost"
export REDIS_PORT="6379"
export REDIS_DATABASE="0"
export REDIS_PASSWORD=""
export MINIO_ENDPOINT="http://localhost:9000"
export MINIO_AK="minioadmin"
export MINIO_SK="minioadmin"

# 启动服务
mvn spring-boot:run
```

### 方案2：使用 AI Profile（需要 DashScope API Key）

```bash
cd /projects/trip_doge

# 设置环境变量
export DASHSCOPE_API_KEY="your-dashscope-api-key"
export SPRING_PROFILES_ACTIVE="ai"
export MYSQL_HOST="localhost"
export MYSQL_DATABASE="trip_dog"
export MYSQL_USERNAME="root"
export MYSQL_PASSWORD=""
export REDIS_HOST="localhost"
export REDIS_PORT="6379"
export REDIS_DATABASE="0"
export REDIS_PASSWORD=""
export MINIO_ENDPOINT="http://localhost:9000"
export MINIO_AK="minioadmin"
export MINIO_SK="minioadmin"
export PGVECTOR_HOST="localhost"
export PGVECTOR_PORT="5432"
export PGVECTOR_DATABASE="trip_dog_vector"
export PGVECTOR_USER="postgres"
export PGVECTOR_PASSWORD="postgres"
export PGVECTOR_TABLE="document_embeddings"
export SEARCH_MCP_LINK="your-mcp-link"

# 启动服务
mvn spring-boot:run
```

## 验证服务启动

等待约90秒后，检查服务状态：

```bash
# 检查健康状态
curl http://localhost:7979/api/actuator/health

# 应该返回：
# {"status":"UP"}
```

## 常见问题

### 1. 服务启动失败：Could not resolve placeholder 'DASHSCOPE_API_KEY'
**原因**: 使用了 `ai` profile 但没有设置 `DASHSCOPE_API_KEY`  
**解决**: 设置 `SPRING_PROFILES_ACTIVE=deepseek` 或设置 `DASHSCOPE_API_KEY`

### 2. 服务启动失败：Could not resolve placeholder 'mcp.search-link'
**原因**: `application.yaml` 中缺少 `mcp.search-link` 配置  
**解决**: 已在 `application.yaml` 中添加默认配置 `mcp.search-link: ""`

### 3. 数据库连接失败
**原因**: MySQL 未启动或配置错误  
**解决**: 检查 MySQL 服务是否运行，验证连接信息

### 4. Redis 连接失败
**原因**: Redis 未启动或配置错误  
**解决**: 检查 Redis 服务是否运行：`redis-cli ping`

## 快速启动脚本

创建 `start-backend.sh`：

```bash
#!/bin/bash
cd /projects/trip_doge

# DeepSeek Profile
export DEEPSEEK_API_KEY="sk-your-deepseek-api-key"
export SPRING_PROFILES_ACTIVE="deepseek"
export MYSQL_HOST="localhost"
export MYSQL_DATABASE="trip_dog"
export MYSQL_USERNAME="root"
export MYSQL_PASSWORD=""
export REDIS_HOST="localhost"
export REDIS_PORT="6379"
export REDIS_DATABASE="0"
export REDIS_PASSWORD=""
export MINIO_ENDPOINT="http://localhost:9000"
export MINIO_AK="minioadmin"
export MINIO_SK="minioadmin"

mvn spring-boot:run
```

使用方法：
```bash
chmod +x start-backend.sh
./start-backend.sh
```

