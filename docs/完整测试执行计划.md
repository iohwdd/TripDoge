# 完整测试执行计划

## 测试目标

验证任务4.1修复后的功能：
1. 后端API返回类型修复（`ChatHistoryDO` → `ChatHistoryVO`）
2. 前端对话页面历史消息正确显示
3. 消息类型字段（`messageType`）正确映射和使用

---

## 第一阶段：环境准备

### 1.1 检查环境变量

```bash
cd /projects/trip_doge
./docs/环境变量配置指南.md  # 参考配置指南

# 检查关键环境变量
echo "DASHSCOPE_API_KEY: ${DASHSCOPE_API_KEY:-(未设置)}"
echo "MYSQL_HOST: ${MYSQL_HOST:-(未设置)}"
echo "MYSQL_DATABASE: ${MYSQL_DATABASE:-(未设置)}"
```

**预期结果**: 所有必需的环境变量已设置

### 1.2 检查依赖服务

```bash
# MySQL
mysql -u ${MYSQL_USERNAME:-root} -p${MYSQL_PASSWORD} -e "SELECT 1" 2>/dev/null && echo "✓ MySQL运行中" || echo "✗ MySQL未运行"

# Redis
redis-cli -h ${REDIS_HOST:-localhost} -p ${REDIS_PORT:-6379} ping 2>/dev/null && echo "✓ Redis运行中" || echo "✗ Redis未运行"

# MinIO（可选）
curl -s ${MINIO_ENDPOINT:-http://localhost:9000}/minio/health/live 2>/dev/null && echo "✓ MinIO运行中" || echo "✗ MinIO未运行"
```

**预期结果**: 至少MySQL和Redis运行中

---

## 第二阶段：启动后端服务

### 2.1 启动后端

```bash
cd /projects/trip_doge

# 方式1：Maven直接运行
mvn spring-boot:run > /tmp/backend.log 2>&1 &

# 方式2：打包后运行
# mvn clean package -DskipTests
# java -jar target/tripdog-backend-1.0.0.jar > /tmp/backend.log 2>&1 &

# 记录进程ID
echo $! > /tmp/backend.pid
```

### 2.2 等待服务启动

```bash
# 等待最多60秒
for i in {1..60}; do
    if curl -s http://localhost:7979/api/actuator/health > /dev/null 2>&1; then
        echo "✓ 后端服务启动成功"
        break
    fi
    echo "等待服务启动... ($i/60)"
    sleep 1
done

# 检查启动日志
tail -20 /tmp/backend.log
```

**预期结果**: 
- 服务在60秒内启动
- 健康检查返回 `{"status":"UP"}`
- 日志中无严重错误

### 2.3 验证启动状态

```bash
# 健康检查
curl -s http://localhost:7979/api/actuator/health | python3 -m json.tool

# 检查Swagger文档
curl -s http://localhost:7979/api/swagger-ui/index.html | head -5
```

**预期结果**: 
- 健康检查返回正常状态
- Swagger UI可访问

---

## 第三阶段：API测试验证

### 3.1 准备测试数据

```bash
# 需要先登录获取token
# 假设已有测试用户，或需要先注册

# 登录获取token
TOKEN=$(curl -s -X POST http://localhost:7979/api/user/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"password123"}' \
  | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('data',{}).get('token',''))" 2>/dev/null)

if [ -z "$TOKEN" ]; then
    echo "⚠ 无法获取token，可能需要先注册用户"
    echo "请手动设置TOKEN: export TOKEN=your_token"
fi
```

### 3.2 执行API测试脚本

```bash
cd /projects/trip_doge
chmod +x docs/API测试验证脚本.sh
./docs/API测试验证脚本.sh
```

**测试项**:
1. ✓ 后端服务健康检查
2. ✓ 用户登录获取token
3. ✓ 获取角色列表
4. ✓ **获取对话历史（关键测试）**
5. ✓ 验证响应数据结构
6. ✓ 测试重置对话

### 3.3 验证API响应格式

**关键验证点**:

1. **响应包含 `messageType` 字段**
   ```bash
   curl -s -X POST http://localhost:7979/api/chat/1/history \
     -H "Authorization: Bearer $TOKEN" \
     | python3 -c "import sys,json; d=json.load(sys.stdin); print('messageType' in str(d))"
   ```
   预期: 返回 `True`

2. **响应不包含 `role` 字段**
   ```bash
   curl -s -X POST http://localhost:7979/api/chat/1/history \
     -H "Authorization: Bearer $TOKEN" \
     | python3 -c "import sys,json; d=json.load(sys.stdin); print('\"role\":' in str(d))"
   ```
   预期: 返回 `False`

3. **响应包含 `roleId` 字段**
   ```bash
   curl -s -X POST http://localhost:7979/api/chat/1/history \
     -H "Authorization: Bearer $TOKEN" \
     | python3 -c "import sys,json; d=json.load(sys.stdin); print('roleId' in str(d))"
   ```
   预期: 返回 `True`

4. **响应数据结构正确**
   ```bash
   curl -s -X POST http://localhost:7979/api/chat/1/history \
     -H "Authorization: Bearer $TOKEN" \
     | python3 -m json.tool
   ```
   预期: 返回格式化的JSON，包含 `code`、`data`（数组）、每个消息包含 `messageType`、`roleId`、`content` 等字段

**预期结果**: 
- ✅ API返回 `ChatHistoryVO[]` 格式
- ✅ 包含 `messageType` 字段（值为 "user"、"assistant" 或 "system"）
- ✅ 包含 `roleId` 字段
- ✅ 不包含 `role` 字段

---

## 第四阶段：前端UI测试验证

### 4.1 启动前端服务

```bash
cd /projects/trip_doge/frontend

# 检查是否已运行
if curl -s http://localhost:5173 > /dev/null 2>&1; then
    echo "✓ 前端服务已在运行"
else
    # 启动前端服务
    npm run dev > /tmp/frontend.log 2>&1 &
    echo $! > /tmp/frontend.pid
    
    # 等待启动
    sleep 5
    echo "前端服务启动中，请访问 http://localhost:5173"
fi
```

### 4.2 前端功能测试清单

#### 4.2.1 基础功能测试

- [ ] **页面加载**
  - 访问 `http://localhost:5173/user`
  - 页面正常加载，无错误

- [ ] **登录功能**
  - 使用测试账号登录
  - 登录成功后跳转到首页

- [ ] **选择专家**
  - 在首页选择一个专家
  - 输入初始消息
  - 点击发送，跳转到对话页面

#### 4.2.2 对话页面测试

- [ ] **页面布局**
  - 顶部显示角色信息（头像、名称、描述）
  - 返回按钮可点击
  - 重置按钮可点击

- [ ] **历史消息显示**（关键测试）
  - 如果有历史消息，正确显示
  - 用户消息显示在右侧（蓝色背景）
  - AI消息显示在左侧（白色背景）
  - 消息时间正确显示
  - 消息内容正确显示

- [ ] **消息类型识别**
  - 用户消息使用用户头像
  - AI消息使用角色头像
  - 消息样式正确区分

- [ ] **输入框功能**
  - 可以输入文本
  - 支持多行输入
  - 回车发送（Shift+Enter换行）
  - 发送按钮状态正确（空内容时禁用）

- [ ] **自动滚动**
  - 新消息自动滚动到底部
  - 滚动动画平滑

- [ ] **重置对话**
  - 点击重置按钮
  - 确认重置
  - 消息列表清空
  - 显示成功提示

- [ ] **返回功能**
  - 点击返回按钮
  - 返回到首页
  - 保留当前对话状态

#### 4.2.3 浏览器控制台检查

打开浏览器开发者工具（F12），检查：

- [ ] **无错误信息**
  - Console中无红色错误
  - Network中API请求成功（200状态码）

- [ ] **API请求验证**
  - `POST /api/chat/{roleId}/history` 请求成功
  - 响应数据格式正确
  - 响应包含 `messageType` 字段

- [ ] **类型安全**
  - TypeScript类型检查通过
  - 无类型错误警告

### 4.3 手动测试步骤

1. **打开浏览器**
   ```
   http://localhost:5173
   ```

2. **登录系统**
   - 使用测试账号登录
   - 或注册新账号

3. **进入对话页面**
   - 在首页选择一个专家
   - 输入消息："你好"
   - 点击发送

4. **验证历史消息**
   - 如果有历史消息，检查显示是否正确
   - 检查消息类型（用户/AI）是否正确区分
   - 检查消息时间是否正确显示

5. **测试发送消息**
   - 输入新消息
   - 点击发送
   - 验证消息显示

6. **测试重置对话**
   - 点击重置按钮
   - 确认重置
   - 验证消息清空

7. **测试返回功能**
   - 点击返回按钮
   - 验证返回首页

---

## 第五阶段：测试结果记录

### 5.1 API测试结果

记录以下信息：

```markdown
## API测试结果

**测试时间**: YYYY-MM-DD HH:MM:SS

**后端服务状态**: ✅ 运行中 / ❌ 未运行

**API端点测试**:
- POST /api/chat/{roleId}/history: ✅ 通过 / ❌ 失败
  - 响应包含 messageType: ✅ / ❌
  - 响应包含 roleId: ✅ / ❌
  - 响应不包含 role: ✅ / ❌
  - 数据结构正确: ✅ / ❌

**响应示例**:
```json
{
  "code": 200,
  "data": [
    {
      "id": 1,
      "conversationId": "...",
      "roleId": 1,
      "messageType": "user",
      "content": "...",
      "createTime": "2025-11-24 12:00:00"
    }
  ]
}
```

**问题记录**:
- 无 / 列出问题
```

### 5.2 前端UI测试结果

记录以下信息：

```markdown
## 前端UI测试结果

**测试时间**: YYYY-MM-DD HH:MM:SS

**前端服务状态**: ✅ 运行中 / ❌ 未运行

**功能测试**:
- 页面加载: ✅ / ❌
- 历史消息显示: ✅ / ❌
- 消息类型识别: ✅ / ❌
- 输入框功能: ✅ / ❌
- 自动滚动: ✅ / ❌
- 重置对话: ✅ / ❌
- 返回功能: ✅ / ❌

**浏览器控制台**:
- 无错误: ✅ / ❌
- API请求成功: ✅ / ❌
- 类型安全: ✅ / ❌

**问题记录**:
- 无 / 列出问题
```

---

## 第六阶段：清理和总结

### 6.1 停止服务（测试完成后）

```bash
# 停止后端服务
if [ -f /tmp/backend.pid ]; then
    kill $(cat /tmp/backend.pid) 2>/dev/null
    rm /tmp/backend.pid
fi

# 停止前端服务
if [ -f /tmp/frontend.pid ]; then
    kill $(cat /tmp/frontend.pid) 2>/dev/null
    rm /tmp/frontend.pid
fi
```

### 6.2 生成测试报告

汇总所有测试结果，生成最终测试报告。

---

## 快速测试命令

```bash
# 一键执行所有测试（需要先配置环境变量）
cd /projects/trip_doge

# 1. 启动后端
mvn spring-boot:run > /tmp/backend.log 2>&1 &
BACKEND_PID=$!

# 2. 等待启动
sleep 30

# 3. 执行API测试
./docs/API测试验证脚本.sh

# 4. 启动前端（另一个终端）
cd frontend && npm run dev

# 5. 手动测试前端UI（浏览器）
# 访问 http://localhost:5173

# 6. 停止服务
kill $BACKEND_PID
```

---

## 预期测试结果

### ✅ 成功标准

1. **后端API**:
   - ✅ 返回 `ChatHistoryVO[]` 格式
   - ✅ 包含 `messageType` 字段
   - ✅ 包含 `roleId` 字段
   - ✅ 不包含 `role` 字段

2. **前端UI**:
   - ✅ 历史消息正确显示
   - ✅ 消息类型正确区分
   - ✅ 所有功能正常

### ❌ 失败情况

如果测试失败，检查：
1. 环境变量是否正确配置
2. 依赖服务是否运行
3. 后端日志中的错误信息
4. 浏览器控制台中的错误信息
5. 网络请求是否成功

---

**测试计划创建时间**: 2025-11-24  
**测试执行**: 待执行


